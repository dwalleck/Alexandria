Update (2017/06/12): Added BenchmarkDotNet blog post link.

There are many exciting aspects to .NET Core (open source, cross platform, x-copy deployable, etc.) that have been covered in posts on this blog before. To me, though, one of the most exciting aspects of .NET Core is performance. There’s been a lot of discussion about the significant advancements that have been made in ASP.NET Core performance, its status as a top contender on various [TechEmpower benchmarks](https://www.techempower.com/benchmarks/#section=data-r14&hw=ph&test=plaintext), and the continual advancements being made in pushing it further. However, there’s been much less discussion about some equally exciting improvements throughout the runtime and the base class libraries.

There are way too many improvements to mention. After all, as an open source project that’s [very accepting of contributions](https://github.com/dotnet/core/blob/master/release-notes/2.0/2.0-preview1-contributor.md), Microsoft and community developers from around the world have found places where performance is important to them and submitted pull requests to improve things. I’d like to thank all the community developers for their .NET Core contributions, some of which are specifically called out in this post. We expect that many of these improvements will be brought to the .NET Framework over the next few releases, too. For this post, I’ll provide a tour through just a small smattering of the performance improvements you’ll find in .NET Core, and in particular in .NET Core 2.0, focusing on a few examples from a variety of the core libraries.

_NOTE: This blog post contains lots of example code and timings. As with any such timings, take them with [a grain of salt](https://en.wikipedia.org/wiki/Grain_of_salt): these were taken on one machine in one configuration (all 64-bit processes), and so you may see different results on different systems. However, I ran each test on [.NET Framework 4.7](https://blogs.msdn.microsoft.com/dotnet/2017/05/02/announcing-the-net-framework-4-7-general-availability/) and [.NET Core 2.0](https://devblogs.microsoft.com/dotnet/announcing-net-core-2-0-preview-1/) on the same machine in the same configuration at approximately the same time, providing a consistent environment for each comparison. Further, normally such testing is best done with a tool like [BenchmarkDotNet](https://github.com/dotnet/BenchmarkDotNet); I’ve not done so for this post simply to make it easy for you to copy-and-paste the samples out into a console app and try them._

_Editor: See the excellent follow-up by [Andrey Akinshin](https://twitter.com/andrey_akinshin) where he [Measures Performance Improvements in .NET Core with BenchmarkDotNet](http://aakinshin.net/blog/post/stephen-toub-benchmarks-part1/)._

#### Collections

Collections are the bedrock of any application, and there are a multitude of collections available in the .NET libraries. Not every operation on every collection has been made faster, but many have. Some of these improvements are due to eliminating overheads, such as streamlining operations to enable better inlining, reducing instruction count, and so on. For example, consider this small example with a [Queue<T>](https://docs.microsoft.com/dotnet/api/system.collections.generic.queue-1):

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_Queue_EnqueueDequeue.cs"><tbody><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC5"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC7"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC9"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC10"><span>{</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC11"><span>var</span> <span>q</span> <span>=</span> <span>new</span> <span>Queue</span><span>&lt;</span><span>int</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC12"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC13"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>100_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC14"><span>{</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC15"><span>q</span><span>.</span><span>Enqueue</span><span>(</span><span>i</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC16"><span>q</span><span>.</span><span>Dequeue</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC17"><span>}</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC18"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC19"><span>}</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC20"><span>}</span></td></tr><tr><td id="file-perfblog06062017_queue_enqueuedequeue-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_queue_enqueuedequeue-cs-LC21"><span>}</span></td></tr></tbody></table>

PR [dotnet/corefx #2515](https://github.com/dotnet/corefx/pull/2515) from [OmariO](https://github.com/omariom) removed from [Enqueue](https://docs.microsoft.com/dotnet/api/system.collections.generic.queue-1.enqueue) and [Dequeue](https://docs.microsoft.com/dotnet/api/system.collections.generic.queue-1.dequeue) a relatively expensive modulus operation that dominated the costs of these operations. On my machine, this code on .NET 4.7 produces output like this:

00:00:00.9392595 00:00:00.9390453 00:00:00.9455784 00:00:00.9508294 00:00:01.0107745

whereas with .NET Core 2.0 it produces output like this:

00:00:00.5514887 00:00:00.5662477 00:00:00.5627481 00:00:00.5685286 00:00:00.5262378

As this is “wall clock” time elapsed, smaller values are better, and this shows an ~2x increase in throughput!

In other cases, operations have been made faster by changing the algorithmic complexity of an operation. It’s often best when writing software to first write a simple implementation, one that’s easily maintained and easily proven correct. However, such implementations often don’t exhibit the best possible performance, and it’s not until a specific scenario comes along that drives a need to improve performance does that happen. For example, [SortedSet<T>](https://docs.microsoft.com/dotnet/api/system.collections.generic.sortedset-1)‘s ctor was originally written in a relatively simple way that didn’t scale well due to (I assume accidentally) employing an O(N^2) algorithm for handling duplicates. The algorithm was fixed in .NET Core in PR [dotnet/corefx #1955](https://github.com/dotnet/corefx/pull/1955). The following short program exemplifies the difference the fix made:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_SortedSet_EnumerableCtor_Duplicates.cs"><tbody><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>Linq</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC5"></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC6"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC7"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC8"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC9"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC10"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC11"><span>var</span> <span>ss</span> <span>=</span> <span>new</span> <span>SortedSet</span><span>&lt;</span><span>int</span><span>&gt;</span><span>(</span><span>Enumerable</span><span>.</span><span>Repeat</span><span>(</span><span>42</span><span>,</span> <span>400_000</span><span>)</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC12"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC13"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_sortedset_enumerablector_duplicates-cs-LC14"><span>}</span></td></tr></tbody></table>

On my system, on .NET Framework this code takes ~7.7 seconds to execute. On .NET Core 2.0, that is reduced to ~0.013s, for an ~600x improvement (at least with 400K elements… as the fix changed the algorithmic complexity, the larger the set, the more the times will diverge).

Or consider this example on [SortedSet<T>](https://docs.microsoft.com/dotnet/api/system.collections.generic.sortedset-1):

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_SortedSet_Min.cs"><tbody><tr><td id="file-perfblog06062017_sortedset_min-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_sortedset_min-cs-LC1"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_sortedset_min-cs-LC2"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_sortedset_min-cs-LC3"><span><span>static</span></span> <span>int</span> <span>s_result</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_sortedset_min-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_sortedset_min-cs-LC5"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_sortedset_min-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_sortedset_min-cs-LC7"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_sortedset_min-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_sortedset_min-cs-LC9"><span>var</span> <span>s</span> <span>=</span> <span>new</span> <span>SortedSet</span><span>&lt;</span><span>int</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_sortedset_min-cs-LC10"><span>for</span> <span>(</span><span>int</span> <span>n</span> <span>=</span> <span>0</span><span>;</span> <span>n</span> <span>&lt;</span> <span>100_000</span><span>;</span> <span>n</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_sortedset_min-cs-LC11"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_sortedset_min-cs-LC12"><span>s</span><span>.</span><span>Add</span><span>(</span><span>n</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_sortedset_min-cs-LC13"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_sortedset_min-cs-LC14"></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_sortedset_min-cs-LC15"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_sortedset_min-cs-LC16"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>10_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_sortedset_min-cs-LC17"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_sortedset_min-cs-LC18"><span>s_result</span> <span>=</span> <span>s</span><span>.</span><span>Min</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_sortedset_min-cs-LC19"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_sortedset_min-cs-LC20"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_sortedset_min-cs-LC21"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_sortedset_min-cs-LC22"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sortedset_min-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_sortedset_min-cs-LC23"><span>}</span></td></tr></tbody></table>

The implementation of [Min](https://docs.microsoft.com/dotnet/api/system.collections.generic.sortedset-1.min) and [Max](https://docs.microsoft.com/dotnet/api/system.collections.generic.sortedset-1.max) in .NET 4.7 walks the whole tree underlying the [SortedSet<T>](https://docs.microsoft.com/dotnet/api/system.collections.generic.sortedset-1), but that’s unnecessary for finding just the min or the max, as the implementation can traverse down to just the relevant node. PR [dotnet/corefx #11968](https://github.com/dotnet/corefx/pull/11968) fixes the .NET Core implementation to do just that. On .NET 4.7, this example produces results like:

00:00:01.1427246 00:00:01.1295220 00:00:01.1350696 00:00:01.1502784 00:00:01.1677880

whereas on .NET Core 2.0, we get results like:

00:00:00.0861391 00:00:00.0861183 00:00:00.0866616 00:00:00.0848434 00:00:00.0860198

showing a sizeable decrease in time and increase in throughput.

Even a core workhorse like [List<T>](https://docs.microsoft.com/dotnet/api/system.collections.generic.list-1) has found room for improvement. Due to JIT improvements and PRs like [dotnet/coreclr #9539](https://github.com/dotnet/coreclr/pull/9539) from [benaadams](https://github.com/benaadams), core operations like [List<T>.Add](https://docs.microsoft.com/dotnet/api/system.collections.generic.list-1.add) have gotten faster. Consider this small example:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_List_AddRemoveAt.cs"><tbody><tr><td id="file-perfblog06062017_list_addremoveat-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC5"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC7"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC9"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC10"><span>{</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC11"><span>var</span> <span>l</span> <span>=</span> <span>new</span> <span>List</span><span>&lt;</span><span>int</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC12"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC13"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>100_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC14"><span>{</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC15"><span>l</span><span>.</span><span>Add</span><span>(</span><span>i</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC16"><span>l</span><span>.</span><span>RemoveAt</span><span>(</span><span>0</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC17"><span>}</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC18"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC19"><span>}</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC20"><span>}</span></td></tr><tr><td id="file-perfblog06062017_list_addremoveat-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_list_addremoveat-cs-LC21"><span>}</span></td></tr></tbody></table>

On .NET 4.7, I get results like:

00:00:00.4434135 00:00:00.4394329 00:00:00.4496867 00:00:00.4496383 00:00:00.4515505

and with .NET Core 2.0, I see:

00:00:00.3213094 00:00:00.3211772 00:00:00.3179631 00:00:00.3198449 00:00:00.3164009

To be sure, the fact that we can do 100 million such adds and removes from a list like this in just 0.3 seconds highlights that the operation wasn’t slow to begin with. But over the execution of an app, lists are often added to a lot, and the savings add up.

These kinds of collections improvements expand beyond just the [System.Collections.Generic](https://docs.microsoft.com/dotnet/api/system.collections.generic) namespace; [System.Collections.Concurrent](https://docs.microsoft.com/dotnet/api/system.collections.concurrent) has had many improvements as well. In fact, both [ConcurrentQueue<T>](https://docs.microsoft.com/dotnet/api/system.collections.concurrent.concurrentqueue-1) and [ConcurrentBag<T>](https://docs.microsoft.com/dotnet/api/system.collections.concurrent.concurrentbag-1) were essentially completely rewritten for .NET Core 2.0, in PRs [dotnet/corefx #14254](https://github.com/dotnet/corefx/pull/14254) and [dotnet/corefx #14126](https://github.com/dotnet/corefx/pull/14126), respectively. Let’s look at a basic example, using [ConcurrentQueue<T>](https://docs.microsoft.com/dotnet/api/system.collections.concurrent.concurrentqueue-1) but without any concurrency, essentially the same example as earlier with [Queue<T>](https://docs.microsoft.com/dotnet/api/system.collections.generic.queue-1) but with [ConcurrentQueue<T>](https://docs.microsoft.com/dotnet/api/system.collections.concurrent.concurrentqueue-1) instead:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_ConcurrentQueue_EnqueueTryDequeue.cs"><tbody><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Collections</span><span>.</span><span>Concurrent</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC5"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC7"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC9"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC10"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC11"><span>var</span> <span>q</span> <span>=</span> <span>new</span> <span>ConcurrentQueue</span><span>&lt;</span><span>int</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC12"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC13"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>100_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC14"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC15"><span>q</span><span>.</span><span>Enqueue</span><span>(</span><span>i</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC16"><span>q</span><span>.</span><span>TryDequeue</span><span>(</span><span>out</span> <span>int</span> <span>_</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC17"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC18"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC19"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC20"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue-cs-LC21"><span>}</span></td></tr></tbody></table>

On my machine on .NET 4.7, this yields output like the following:

00:00:02.6485174 00:00:02.6144919 00:00:02.6699958 00:00:02.6441047 00:00:02.6255135

Obviously the [ConcurrentQueue<T>](https://docs.microsoft.com/dotnet/api/system.collections.concurrent.concurrentqueue-1) example on .NET 4.7 is slower than the [Queue<T>](https://docs.microsoft.com/dotnet/api/system.collections.generic.queue-1) version on .NET 4.7, as [ConcurrentQueue<T>](https://docs.microsoft.com/dotnet/api/system.collections.concurrent.concurrentqueue-1) needs to employ synchronization to ensure it can be used safely concurrently. But the more interesting comparison is what happens when we run the same code on .NET Core 2.0:

00:00:01.7700190 00:00:01.8324078 00:00:01.7552966 00:00:01.7518632 00:00:01.7560811

This shows that the throughput using [ConcurrentQueue<T>](https://docs.microsoft.com/dotnet/api/system.collections.concurrent.concurrentqueue-1) without any concurrency improves when switching to .NET Core 2.0 by ~30%. But there are even more interesting aspects. The changes in the implementation improved serialized throughput, but even more so reduced the synchronization between producers and consumers using the queue, which can have a more demonstrable impact on throughput. Consider the following code instead:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_ConcurrentQueue_ProducerSpinningConsumer.cs"><tbody><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Collections</span><span>.</span><span>Concurrent</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>Threading</span><span>.</span><span>Tasks</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC5"></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC6"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC7"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC8"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC9"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC10"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC11"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC12"><span>const</span> <span>int</span> <span>Items</span> <span>=</span> <span>100_000_000</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC13"><span>var</span> <span>q</span> <span>=</span> <span>new</span> <span>ConcurrentQueue</span><span>&lt;</span><span>int</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC14"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC15"></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC16"><span>Task</span> <span>consumer</span> <span>=</span> <span>Task</span><span>.</span><span>Run</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC17"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC18"><span>int</span> <span>total</span> <span>=</span> <span>0</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC19"><span>while</span> <span>(</span><span>total</span> <span>&lt;</span> <span>Items</span><span>)</span> <span>if</span> <span>(</span><span>q</span><span>.</span><span>TryDequeue</span><span>(</span><span>out</span> <span>int</span> <span>_</span><span>)</span><span>)</span> <span>total</span><span>++</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC20"><span>}</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC21"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>Items</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>q</span><span>.</span><span>Enqueue</span><span>(</span><span>i</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC22"><span>consumer</span><span>.</span><span>Wait</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC23"></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC24"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L25" data-line-number="25"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC25"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L26" data-line-number="26"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC26"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-L27" data-line-number="27"></td><td id="file-perfblog06062017_concurrentqueue_producerspinningconsumer-cs-LC27"><span>}</span></td></tr></tbody></table>

This example is spawing a consumer that sits in a tight loop dequeueing any elements it can find, until it consumes everything the producer adds. On .NET 4.7, this outputs results on my machine like the following:

00:00:06.1366044 00:00:05.7169339 00:00:06.3870274 00:00:05.5487718 00:00:06.6069291

whereas with .NET Core 2.0, I see results like the following:

00:00:01.2052460 00:00:01.5269184 00:00:01.4638793 00:00:01.4963922 00:00:01.4927520

That’s an ~3.5x throughput increase. But better CPU efficiency isn’t the only impact of the rewrite; memory allocation is also substantially decreased. Consider a small variation to the original test, this time looking at the number of GC collections instead of the wall-clock time:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_ConcurrentQueue_EnqueueTryDequeue_Memory.cs"><tbody><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Collections</span><span>.</span><span>Concurrent</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC5"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC7"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC9"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC10"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC11"><span>var</span> <span>q</span> <span>=</span> <span>new</span> <span>ConcurrentQueue</span><span>&lt;</span><span>int</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC12"><span>int</span> <span>gen0</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span><span>,</span> <span>gen1</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span><span>,</span> <span>gen2</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC13"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>100_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC14"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC15"><span>q</span><span>.</span><span>Enqueue</span><span>(</span><span>i</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC16"><span>q</span><span>.</span><span>TryDequeue</span><span>(</span><span>out</span> <span>int</span> <span>_</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC17"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC18"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span><span>$</span>"Gen0=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span> <span>-</span> <span>gen0</span><span>}</span> Gen1=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span> <span>-</span> <span>gen1</span><span>}</span> Gen2=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span> <span>-</span> <span>gen2</span><span>}</span>"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC19"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC20"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_concurrentqueue_enqueuetrydequeue_memory-cs-LC21"><span>}</span></td></tr></tbody></table>

On .NET 4.7, I get output like the following:

Gen0=162 Gen1=80 Gen2=0 Gen0=162 Gen1=81 Gen2=0 Gen0=162 Gen1=81 Gen2=0 Gen0=162 Gen1=81 Gen2=0 Gen0=162 Gen1=81 Gen2=0

whereas with .NET Core 2.0, I get output like the following:

Gen0=0 Gen1=0 Gen2=0 Gen0=0 Gen1=0 Gen2=0 Gen0=0 Gen1=0 Gen2=0 Gen0=0 Gen1=0 Gen2=0 Gen0=0 Gen1=0 Gen2=0

That’s not a typo: 0 collections. The implementation in .NET 4.7 employs a linked list of fixed-size arrays that are thrown away once the fixed number of elements are added to each; this helps to simplify the implementation, but results in lots of garbage being generated for the segments. In .NET Core 2.0, the new implementation still employs a linked list of segments, but these segments increase in size as new segments are added, and more importantly, utilize circular buffers, such that new segments only need be added if the previous segment is entirely full (though other operations on the collection, such as enumeration, can also cause the current segments to be frozen and force new segments to be created in the future). Such reductions in allocation can have a sizeable impact on the overall performance of an application.

Similar improvements surface with [ConcurrentBag<T>](https://docs.microsoft.com/dotnet/api/system.collections.concurrent.concurrentbag-1). [ConcurrentBag<T>](https://docs.microsoft.com/dotnet/api/system.collections.concurrent.concurrentbag-1) maintains thread-local work-stealing queues, such that every thread that adds to the bag has its own queue. In .NET 4.7, these queues are implemented as linked lists of one node per element, which means that any addition to the bag incurs an allocation. In .NET Core 2.0, these queues are now arrays, which means that other than the amortized costs involved in growing the arrays, additions are allocation-free. This can be seen in the following repro:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_ConcurrentBag_AddTryTake.cs"><tbody><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Collections</span><span>.</span><span>Concurrent</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC5"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC7"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC9"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC10"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC11"><span>var</span> <span>q</span> <span>=</span> <span>new</span> <span>ConcurrentBag</span><span>&lt;</span><span>int</span><span>&gt;</span><span>(</span><span>)</span> <span>{</span> <span>1</span><span>,</span> <span>2</span> <span>}</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC12"><span>var</span> <span>sw</span> <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC13"></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC14"><span>int</span> <span>gen0</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span><span>,</span> <span>gen1</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span><span>,</span> <span>gen2</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC15"><span>sw</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC16"></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC17"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>100_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC18"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC19"><span>q</span><span>.</span><span>Add</span><span>(</span><span>i</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC20"><span>q</span><span>.</span><span>TryTake</span><span>(</span><span>out</span> <span>int</span> <span>_</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC21"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC22"></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC23"><span>sw</span><span>.</span><span>Stop</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC24"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span><span>$</span>"Elapsed=<span>{</span><span>sw</span><span>.</span><span>Elapsed</span><span>}</span> Gen0=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span> <span>-</span> <span>gen0</span><span>}</span> Gen1=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span> <span>-</span> <span>gen1</span><span>}</span> Gen2=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span> <span>-</span> <span>gen2</span><span>}</span>"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L25" data-line-number="25"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC25"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L26" data-line-number="26"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC26"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-L27" data-line-number="27"></td><td id="file-perfblog06062017_concurrentbag_addtrytake-cs-LC27"><span>}</span></td></tr></tbody></table>

On .NET 4.7, this yields the following output on my machine:

Elapsed=00:00:06.5672723 Gen0=953 Gen1=0 Gen2=0 Elapsed=00:00:06.4829793 Gen0=954 Gen1=1 Gen2=0 Elapsed=00:00:06.9008532 Gen0=954 Gen1=0 Gen2=0 Elapsed=00:00:06.6485667 Gen0=953 Gen1=1 Gen2=0 Elapsed=00:00:06.4671746 Gen0=954 Gen1=1 Gen2=0

whereas with .NET Core 2.0 I get:

Elapsed=00:00:04.3377355 Gen0=0 Gen1=0 Gen2=0 Elapsed=00:00:04.2892791 Gen0=0 Gen1=0 Gen2=0 Elapsed=00:00:04.3101593 Gen0=0 Gen1=0 Gen2=0 Elapsed=00:00:04.2652497 Gen0=0 Gen1=0 Gen2=0 Elapsed=00:00:04.2808077 Gen0=0 Gen1=0 Gen2=0

That’s an ~30% improvement in throughput, and a huge (complete) reduction in allocations and resulting garbage collections.

#### LINQ

In application code, collections often go hand-in-hand with Language Integrated Query (LINQ), which has seen even more improvements. Many of the operators in LINQ have been entirely rewritten for .NET Core in order to reduce the number and size of allocations, reduce algorithmic complexity, and generally eliminate unnecessary work.

For example, the [Enumerable.Concat](https://docs.microsoft.com/dotnet/api/system.linq.enumerable.concat--1) method is used to create a single [IEnumerable<T>](https://docs.microsoft.com/dotnet/api/system.collections.generic.ienumerable-1) that first yields all of the elements of one enumerable and then all the elements of a second. Its implementation in .NET 4.7 is simple and easy to understand, reflecting exactly this statement of behavior:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_ReferenceSource_ConcatIterator.cs"><tbody><tr><td id="file-perfblog06062017_referencesource_concatiterator-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_referencesource_concatiterator-cs-LC1"><span>// https://referencesource.microsoft.com/#System.Core/System/Linq/Enumerable.cs,692</span></td></tr><tr><td id="file-perfblog06062017_referencesource_concatiterator-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_referencesource_concatiterator-cs-LC2"><span><span>static</span></span> <span>IEnumerable</span><span>&lt;</span><span>TSource</span><span>&gt;</span> <span>ConcatIterator</span><span>&lt;</span><span>TSource</span><span>&gt;</span><span>(</span><span>IEnumerable</span><span>&lt;</span><span>TSource</span><span>&gt;</span> <span>first</span><span>,</span> <span>IEnumerable</span><span>&lt;</span><span>TSource</span><span>&gt;</span> <span>second</span><span>)</span> <span>{</span></td></tr><tr><td id="file-perfblog06062017_referencesource_concatiterator-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_referencesource_concatiterator-cs-LC3"><span>foreach</span> <span>(</span><span>TSource</span> <span>element</span> <span>in</span> <span>first</span><span>)</span> <span>yield</span> <span>return</span> <span>element</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_referencesource_concatiterator-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_referencesource_concatiterator-cs-LC4"><span>foreach</span> <span>(</span><span>TSource</span> <span>element</span> <span>in</span> <span>second</span><span>)</span> <span>yield</span> <span>return</span> <span>element</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_referencesource_concatiterator-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_referencesource_concatiterator-cs-LC5"><span>}</span></td></tr></tbody></table>

This is about as good as you can expect when the two sequences are simple enumerables like those produced by an iterator in C#. But what if application code instead had code like the following?

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_NestedConcatCalls.cs"><tbody><tr><td id="file-perfblog06062017_nestedconcatcalls-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_nestedconcatcalls-cs-LC1"><span>first</span><span>.</span><span>Concat</span><span>(</span><span>second</span><span>.</span><span>Concat</span><span>(</span><span>third</span><span>.</span><span>Concat</span><span>(</span><span>fourth</span><span>)</span><span>)</span><span>)</span><span>;</span></td></tr></tbody></table>

Every time we yield out of an iterator, we return out of the enumerator’s [MoveNext](https://docs.microsoft.com/dotnet/api/system.collections.ienumerator.movenext) method. That means if you yield an element from enumerating another iterator, you’re returning out of two [MoveNext](https://docs.microsoft.com/dotnet/api/system.collections.ienumerator.movenext) methods, and moving to the next element requires calling back into both of those [MoveNext](https://docs.microsoft.com/dotnet/api/system.collections.ienumerator.movenext) methods. The more enumerators you need to call into, the longer the operation takes, especially since every one of those operations involves multiple interface calls ([MoveNext](https://docs.microsoft.com/dotnet/api/system.collections.ienumerator.movenext) and [Current](https://docs.microsoft.com/dotnet/api/system.collections.ienumerator.current)). That means that concatenating multiple enumerables grows exponentially rather than linearly with the number of enumerables involved. PR [dotnet/corefx #6131](https://github.com/dotnet/corefx/pull/6131) fixed that, and the difference is obvious in the following example, which concatenates 10K enumerables of 10 elements each:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_Concat_Timing.cs"><tbody><tr><td id="file-perfblog06062017_concat_timing-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_concat_timing-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_concat_timing-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_concat_timing-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_concat_timing-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>Linq</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_concat_timing-cs-LC5"></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_concat_timing-cs-LC6"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_concat_timing-cs-LC7"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_concat_timing-cs-LC8"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_concat_timing-cs-LC9"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_concat_timing-cs-LC10"><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span> <span>zeroToTen</span> <span>=</span> <span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span> <span>10</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_concat_timing-cs-LC11"><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span> <span>result</span> <span>=</span> <span>zeroToTen</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_concat_timing-cs-LC12"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>10_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_concat_timing-cs-LC13"><span>{</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_concat_timing-cs-LC14"><span>result</span> <span>=</span> <span>result</span><span>.</span><span>Concat</span><span>(</span><span>zeroToTen</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_concat_timing-cs-LC15"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_concat_timing-cs-LC16"></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_concat_timing-cs-LC17"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_concat_timing-cs-LC18"><span>foreach</span> <span>(</span><span>int</span> <span>i</span> <span>in</span> <span>result</span><span>)</span> <span>{</span> <span>}</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_concat_timing-cs-LC19"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_concat_timing-cs-LC20"><span>}</span></td></tr><tr><td id="file-perfblog06062017_concat_timing-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_concat_timing-cs-LC21"><span>}</span></td></tr></tbody></table>

On my machine on .NET 4.7, this takes ~4.12 seconds. On my machine on .NET Core 2.0, this takes only ~0.14 seconds, for an ~30x improvement.

Other operators have been improved substantially by eliminating overheads involved when various operators are used together. For example, a multitude of PRs from [JonHanna](https://github.com/JonHanna) have gone into optimizing various such cases and into making it easier to add more cases in the future. Consider this example:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_OrderbBySkipFirst.cs"><tbody><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>Linq</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC5"></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC6"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC7"><span>{</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC8"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC9"><span>{</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC10"><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span> <span>tenMillionToZero</span> <span>=</span> <span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span> <span>10_000_000</span><span>)</span><span>.</span><span>Reverse</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC11"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC12"><span>{</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC13"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC14"><span>int</span> <span>fifth</span> <span>=</span> <span>tenMillionToZero</span><span>.</span><span>OrderBy</span><span>(</span>i <span>=&gt;</span> <span>i</span><span>)</span><span>.</span><span>Skip</span><span>(</span><span>4</span><span>)</span><span>.</span><span>First</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC15"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC16"><span>}</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC17"><span>}</span></td></tr><tr><td id="file-perfblog06062017_orderbbyskipfirst-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_orderbbyskipfirst-cs-LC18"><span>}</span></td></tr></tbody></table>

Here we create an enumerable of the numbers 10,000,000 down to 0, and then time how long it takes to sort them ascending, skip the first 4 elements of the sorted result, and grab the fifth one (which will be 4, as the sequence starts at 0). On my machine on .NET 4.7, I get output like:

00:00:01.3879042 00:00:01.3438509 00:00:01.4141820 00:00:01.4248908 00:00:01.3548279

whereas with .NET Core 2.0, I get output like:

00:00:00.1776617 00:00:00.1787467 00:00:00.1754809 00:00:00.1765863 00:00:00.1735489

That’s a sizeable improvement (~8x), in this case due primarily (though not exclusively) to PR [dotnet/corefx #2401](https://github.com/dotnet/corefx/pull/2401), which avoids most of the costs of the sort.

Similarly, PR [dotnet/corefx #3429](https://github.com/dotnet/corefx/pull/3429) from [justinvp](https://github.com/justinvp) added optimizations around the common [ToList](https://docs.microsoft.com/dotnet/api/system.linq.enumerable.tolist--1) method, providing optimized paths for when the source had a known length, and plumbing that through operators like [Select](https://docs.microsoft.com/dotnet/api/system.linq.enumerable.select). The impact of this is evident in a simple test like the following:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_SelectToList.cs"><tbody><tr><td id="file-perfblog06062017_selecttolist-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_selecttolist-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_selecttolist-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_selecttolist-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_selecttolist-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>Linq</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_selecttolist-cs-LC5"></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_selecttolist-cs-LC6"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_selecttolist-cs-LC7"><span>{</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_selecttolist-cs-LC8"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_selecttolist-cs-LC9"><span>{</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_selecttolist-cs-LC10"><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span> <span>zeroToTenMillion</span> <span>=</span> <span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span> <span>10_000_000</span><span>)</span><span>.</span><span>ToArray</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_selecttolist-cs-LC11"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_selecttolist-cs-LC12"><span>{</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_selecttolist-cs-LC13"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_selecttolist-cs-LC14"><span>zeroToTenMillion</span><span>.</span><span>Select</span><span>(</span>i <span>=&gt;</span> <span>i</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_selecttolist-cs-LC15"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_selecttolist-cs-LC16"><span>}</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_selecttolist-cs-LC17"><span>}</span></td></tr><tr><td id="file-perfblog06062017_selecttolist-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_selecttolist-cs-LC18"><span>}</span></td></tr></tbody></table>

On .NET 4.7, this provides results like:

00:00:00.1308687 00:00:00.1228546 00:00:00.1268445 00:00:00.1247647 00:00:00.1503511

whereas on .NET Core 2.0, I get results like the following:

00:00:00.0386857 00:00:00.0337234 00:00:00.0346344 00:00:00.0345419 00:00:00.0355355

showing an ~4x increase in throughput.

In other cases, the performance wins have come from streamlining the implementation to avoid overheads, such as reducing allocations, avoiding delegate allocations, avoiding interface calls, minimizing field reads and writes, avoiding copies, and so on. For example, [jamesqo](https://github.com/jamesqo) contributed PR [dotnet/corefx #11208](https://github.com/dotnet/corefx/pull/11208), which substantially reduced overheads involved in [Enumerable.ToArray](https://docs.microsoft.com/dotnet/api/system.linq.enumerable.toarray--1), in particular by better managing how the internal buffer(s) used grow to accommodate the unknown amount of data being aggregated. To see this, consider this simple example:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_ToArray.cs"><tbody><tr><td id="file-perfblog06062017_toarray-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_toarray-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_toarray-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_toarray-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_toarray-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>Linq</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_toarray-cs-LC5"></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_toarray-cs-LC6"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_toarray-cs-LC7"><span>{</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_toarray-cs-LC8"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_toarray-cs-LC9"><span>{</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_toarray-cs-LC10"><span>IEnumerable</span><span>&lt;</span><span>int</span><span>&gt;</span> <span>source</span> <span>=</span> <span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span> <span>100_000_000</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_toarray-cs-LC11"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_toarray-cs-LC12"><span>{</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_toarray-cs-LC13"><span>var</span> <span>sw</span> <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_toarray-cs-LC14"><span>int</span> <span>gen0</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span><span>,</span> <span>gen1</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span><span>,</span> <span>gen2</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_toarray-cs-LC15"><span>sw</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_toarray-cs-LC16"></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_toarray-cs-LC17"><span>source</span><span>.</span><span>ToArray</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_toarray-cs-LC18"></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_toarray-cs-LC19"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span><span>$</span>"Elapsed=<span>{</span><span>sw</span><span>.</span><span>Elapsed</span><span>}</span> Gen0=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span> <span>-</span> <span>gen0</span><span>}</span> Gen1=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span> <span>-</span> <span>gen1</span><span>}</span> Gen2=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span> <span>-</span> <span>gen2</span><span>}</span>"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_toarray-cs-LC20"><span>}</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_toarray-cs-LC21"><span>}</span></td></tr><tr><td id="file-perfblog06062017_toarray-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_toarray-cs-LC22"><span>}</span></td></tr></tbody></table>

On .NET 4.7, I get results like:

Elapsed=00:00:01.0548794 Gen0=2 Gen1=2 Gen2=2 Elapsed=00:00:01.1147146 Gen0=2 Gen1=2 Gen2=2 Elapsed=00:00:01.0709146 Gen0=2 Gen1=2 Gen2=2 Elapsed=00:00:01.0706030 Gen0=2 Gen1=2 Gen2=2 Elapsed=00:00:01.0620943 Gen0=2 Gen1=2 Gen2=2

and on .NET Core 2.0, results like:

Elapsed=00:00:00.1716550 Gen0=1 Gen1=1 Gen2=1 Elapsed=00:00:00.1720829 Gen0=1 Gen1=1 Gen2=1 Elapsed=00:00:00.1717145 Gen0=1 Gen1=1 Gen2=1 Elapsed=00:00:00.1713335 Gen0=1 Gen1=1 Gen2=1 Elapsed=00:00:00.1705285 Gen0=1 Gen1=1 Gen2=1

so for this example ~6x faster with half the garbage collections.

There are over a hundred operators in LINQ, and while I’ve only mentioned a few, many of them have been subject to these kinds of improvements.

#### Compression

The examples shown thus far, of collections and LINQ, have been about manipulating data in memory. There are of course many other forms of data manipulation, including transformations that are heavily CPU-bound in nature. Investments have also been made in improving such operations.

One key example is compression, such as with [DeflateStream](https://docs.microsoft.com/dotnet/api/system.io.compression.deflatestream), and several impactful performance changes have gone in here. For example, in .NET 4.7, zlib (a native compression library) is used for compressing data, but a relatively unoptimized managed implementation is used for decompressing data; PR [dotnet/corefx #2906](https://github.com/dotnet/corefx/pull/2906) added .NET Core support for using zlib for decompression as well. And PR [dotnet/corefx #5674](https://github.com/dotnet/corefx/pull/5674) from [bjjones](https://github.com/bjjones) enabled using a more optimized version of zlib produced by Intel. These combine to a fairly dramatic effect. Consider this example, which just creates a large array of (fairly compressible) data:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_CompressDecompress.cs"><tbody><tr><td id="file-perfblog06062017_compressdecompress-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_compressdecompress-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_compressdecompress-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>IO</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_compressdecompress-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>IO</span><span>.</span><span>Compression</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_compressdecompress-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_compressdecompress-cs-LC5"></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_compressdecompress-cs-LC6"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_compressdecompress-cs-LC7"><span>{</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_compressdecompress-cs-LC8"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_compressdecompress-cs-LC9"><span>{</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_compressdecompress-cs-LC10"><span>// Create some fairly compressible data</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_compressdecompress-cs-LC11"><span>byte</span><span>[</span><span>]</span> <span>raw</span> <span>=</span> <span>new</span> <span>byte</span><span>[</span><span>100</span> <span>*</span> <span>1024</span> <span>*</span> <span>1024</span><span>]</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_compressdecompress-cs-LC12"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>raw</span><span>.</span><span>Length</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>raw</span><span>[</span><span>i</span><span>]</span> <span>=</span> <span>(</span><span>byte</span><span>)</span><span>i</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_compressdecompress-cs-LC13"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_compressdecompress-cs-LC14"></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_compressdecompress-cs-LC15"><span>// Compress it</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_compressdecompress-cs-LC16"><span>var</span> <span>compressed</span> <span>=</span> <span>new</span> <span>MemoryStream</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_compressdecompress-cs-LC17"><span>using</span> <span>(</span><span>DeflateStream</span> <span>ds</span> <span>=</span> <span>new</span> <span>DeflateStream</span><span>(</span><span>compressed</span><span>,</span> <span>CompressionMode</span><span>.</span><span>Compress</span><span>,</span> <span>true</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_compressdecompress-cs-LC18"><span>{</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_compressdecompress-cs-LC19"><span>ds</span><span>.</span><span>Write</span><span>(</span><span>raw</span><span>,</span> <span>0</span><span>,</span> <span>raw</span><span>.</span><span>Length</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_compressdecompress-cs-LC20"><span>}</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_compressdecompress-cs-LC21"><span>compressed</span><span>.</span><span>Position</span> <span>=</span> <span>0</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_compressdecompress-cs-LC22"></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_compressdecompress-cs-LC23"><span>// Decompress it</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_compressdecompress-cs-LC24"><span>var</span> <span>decompressed</span> <span>=</span> <span>new</span> <span>MemoryStream</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L25" data-line-number="25"></td><td id="file-perfblog06062017_compressdecompress-cs-LC25"><span>using</span> <span>(</span><span>DeflateStream</span> <span>ds</span> <span>=</span> <span>new</span> <span>DeflateStream</span><span>(</span><span>compressed</span><span>,</span> <span>CompressionMode</span><span>.</span><span>Decompress</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L26" data-line-number="26"></td><td id="file-perfblog06062017_compressdecompress-cs-LC26"><span>{</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L27" data-line-number="27"></td><td id="file-perfblog06062017_compressdecompress-cs-LC27"><span>ds</span><span>.</span><span>CopyTo</span><span>(</span><span>decompressed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L28" data-line-number="28"></td><td id="file-perfblog06062017_compressdecompress-cs-LC28"><span>}</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L29" data-line-number="29"></td><td id="file-perfblog06062017_compressdecompress-cs-LC29"><span>decompressed</span><span>.</span><span>Position</span> <span>=</span> <span>0</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L30" data-line-number="30"></td><td id="file-perfblog06062017_compressdecompress-cs-LC30"></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L31" data-line-number="31"></td><td id="file-perfblog06062017_compressdecompress-cs-LC31"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L32" data-line-number="32"></td><td id="file-perfblog06062017_compressdecompress-cs-LC32"><span>}</span></td></tr><tr><td id="file-perfblog06062017_compressdecompress-cs-L33" data-line-number="33"></td><td id="file-perfblog06062017_compressdecompress-cs-LC33"><span>}</span></td></tr></tbody></table>

On .NET 4.7, for this one compression/decompression operation I get results like:

00:00:00.7977190

whereas with .NET Core 2.0, I get results like:

00:00:00.1926701

#### Cryptography

Another common source of compute in a .NET application is the use of cryptographic operations. Improvements can be seen here as well. For example, in .NET 4.7, [SHA256.Create](https://docs.microsoft.com/dotnet/api/system.security.cryptography.sha256.create) returns a [SHA256](https://docs.microsoft.com/dotnet/api/system.security.cryptography.sha256) type implemented in [managed code](https://docs.microsoft.com/dotnet/api/system.security.cryptography.sha256managed?view=netframework-4.7), and while managed code can be made to run very fast, for very compute-bound computations it’s still hard to compete with the raw throughput and compiler optimizations available to code written in C/C++. In contrast, for .NET Core 2.0, [SHA256.Create](https://docs.microsoft.com/dotnet/api/system.security.cryptography.sha256.create) returns an implementation based on the underlying operating system, e.g. using CNG on Windows or OpenSSL on Unix. The impact can be seen in this simple example that hashes a 100MB byte array:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_SHA256_ComputeHash.cs"><tbody><tr><td id="file-perfblog06062017_sha256_computehash-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Security</span><span>.</span><span>Cryptography</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC5"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC7"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC9"><span>byte</span><span>[</span><span>]</span> <span>raw</span> <span>=</span> <span>new</span> <span>byte</span><span>[</span><span>100</span> <span>*</span> <span>1024</span> <span>*</span> <span>1024</span><span>]</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC10"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>raw</span><span>.</span><span>Length</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>raw</span><span>[</span><span>i</span><span>]</span> <span>=</span> <span>(</span><span>byte</span><span>)</span><span>i</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC11"></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC12"><span>using</span> <span>(</span><span>var</span> <span>sha</span> <span>=</span> <span>SHA256</span><span>.</span><span>Create</span><span>(</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC13"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC14"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC15"><span>sha</span><span>.</span><span>ComputeHash</span><span>(</span><span>raw</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC16"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC17"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC18"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sha256_computehash-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_sha256_computehash-cs-LC19"><span>}</span></td></tr></tbody></table>

On .NET 4.7, I get:

00:00:00.7576808

whereas with .NET Core 2.0, I get:

00:00:00.4032290

Another nice improvement for zero code changes.

#### Math

Mathematical operations are also a large source of computation, especially when dealing with large numbers. Through PRs like [dotnet/corefx #2182](https://github.com/dotnet/corefx/pull/2182), [axelheer](https://github.com/axelheer) made some substantial improvements to various operations on [BigInteger](https://docs.microsoft.com/dotnet/api/system.numerics.biginteger). Consider the following example:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_BigInteger_ModPow.cs"><tbody><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Numerics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC5"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC7"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC9"><span>var</span> <span>rand</span> <span>=</span> <span>new</span> <span>Random</span><span>(</span><span>42</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC10"><span>BigInteger</span> <span>a</span> <span>=</span> <span>Create</span><span>(</span><span>rand</span><span>,</span> <span>8192</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC11"><span>BigInteger</span> <span>b</span> <span>=</span> <span>Create</span><span>(</span><span>rand</span><span>,</span> <span>8192</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC12"><span>BigInteger</span> <span>c</span> <span>=</span> <span>Create</span><span>(</span><span>rand</span><span>,</span> <span>8192</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC13"></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC14"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC15"><span>BigInteger</span><span>.</span><span>ModPow</span><span>(</span><span>a</span><span>,</span> <span>b</span><span>,</span> <span>c</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC16"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC17"><span>}</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC18"></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC19"><span>private</span> <span><span>static</span></span> <span>BigInteger</span> <span>Create</span><span>(</span><span>Random</span> <span>rand</span><span>,</span> <span>int</span> <span>bits</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC20"><span>{</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC21"><span>var</span> <span>value</span> <span>=</span> <span>new</span> <span>byte</span><span>[</span><span>(</span><span>bits</span> <span>+</span> <span>7</span><span>)</span> <span>/</span> <span>8</span> <span>+</span> <span>1</span><span>]</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC22"><span>rand</span><span>.</span><span>NextBytes</span><span>(</span><span>value</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC23"><span>value</span><span>[</span><span>value</span><span>.</span><span>Length</span> <span>-</span> <span>1</span><span>]</span> <span>=</span> <span>0</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC24"><span>return</span> <span>new</span> <span>BigInteger</span><span>(</span><span>value</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L25" data-line-number="25"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC25"><span>}</span></td></tr><tr><td id="file-perfblog06062017_biginteger_modpow-cs-L26" data-line-number="26"></td><td id="file-perfblog06062017_biginteger_modpow-cs-LC26"><span>}</span></td></tr></tbody></table>

On my machine on .NET 4.7, this outputs results like:

00:00:05.6024158

The same code on .NET Core 2.0 instead outputs results like:

00:00:01.2707089

This is another great example of a developer caring a lot about a particular area of .NET and helping to make it better for their own needs and for everyone else that might be using it.

Even some math operations on core integral types have been improved. For example, consider:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_Math_DivRem.cs"><tbody><tr><td id="file-perfblog06062017_math_divrem-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_math_divrem-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_math_divrem-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_math_divrem-cs-LC3"></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_math_divrem-cs-LC4"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_math_divrem-cs-LC5"><span>{</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_math_divrem-cs-LC6"><span>private</span> <span><span>static</span></span> <span>long</span> <span>a</span> <span>=</span> <span>99</span><span>,</span> <span>b</span> <span>=</span> <span>10</span><span>,</span> <span>div</span><span>,</span> <span>rem</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_math_divrem-cs-LC7"></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_math_divrem-cs-LC8"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_math_divrem-cs-LC9"><span>{</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_math_divrem-cs-LC10"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_math_divrem-cs-LC11"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>100_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_math_divrem-cs-LC12"><span>{</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_math_divrem-cs-LC13"><span>div</span> <span>=</span> <span>Math</span><span>.</span><span>DivRem</span><span>(</span><span>a</span><span>,</span> <span>b</span><span>,</span> <span>out</span> <span>rem</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_math_divrem-cs-LC14"><span>}</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_math_divrem-cs-LC15"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_math_divrem-cs-LC16"><span>}</span></td></tr><tr><td id="file-perfblog06062017_math_divrem-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_math_divrem-cs-LC17"><span>}</span></td></tr></tbody></table>

PR [dotnet/coreclr #8125](https://github.com/dotnet/coreclr/pull/8125) replaced [DivRem](https://docs.microsoft.com/dotnet/api/system.math.divrem) with a faster implementation, such that on .NET 4.7 I get results like:

00:00:01.4143100

and on .NET Core 2.0 I get results like:

00:00:00.7469733

for an ~2x improvement in throughput.

#### Serialization

Binary serialization is another area of .NET that can be fairly CPU/data/memory intensive. [BinaryFormatter](https://docs.microsoft.com/dotnet/api/system.runtime.serialization.formatters.binary.binaryformatter) is a component that was initially left out of .NET Core, but it reappears in .NET Core 2.0 in support of existing code that needs it (in general, other forms of serialization are recommended for new code). The component is almost an identical port of the code from .NET 4.7, with the exception of tactical fixes that have been made to it since, in particular around performance. For example, PR [dotnet/corefx #17949](https://github.com/dotnet/corefx/pull/17949) is a one-line fix that increases the maximum size that a particular array is allowed to grow to, but that one change can have a substantial impact on throughput, by allowing for an O(N) algorithm to operate for much longer than it previously would have before switching to an O(N^2) algorithm. This is evident in the following code example:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_BinaryFormatter_Deserialize.cs"><tbody><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Collections</span><span>.</span><span>Generic</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>IO</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC5"><span>using</span> <span>System</span><span>.</span><span>Runtime</span><span>.</span><span>Serialization</span><span>.</span><span>Formatters</span><span>.</span><span>Binary</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC6"></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC7"><span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC9"><span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC10"><span>{</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC11"><span>var</span> <span>books</span> <span>=</span> <span>new</span> <span>List</span><span>&lt;</span><span>Book</span><span>&gt;</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC12"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>1_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC13"><span>{</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC14"><span>string</span> <span>id</span> <span>=</span> <span>i</span><span>.</span><span>ToString</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC15"><span>books</span><span>.</span><span>Add</span><span>(</span><span>new</span> <span>Book</span> <span>{</span> <span>Name</span> <span>=</span> <span>id</span><span>,</span> <span>Id</span> <span>=</span> <span>id</span> <span>}</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC16"><span>}</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC17"></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC18"><span>var</span> <span>formatter</span> <span>=</span> <span>new</span> <span>BinaryFormatter</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC19"><span>var</span> <span>mem</span> <span>=</span> <span>new</span> <span>MemoryStream</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC20"><span>formatter</span><span>.</span><span>Serialize</span><span>(</span><span>mem</span><span>,</span> <span>books</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC21"><span>mem</span><span>.</span><span>Position</span> <span>=</span> <span>0</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC22"></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC23"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC24"><span>formatter</span><span>.</span><span>Deserialize</span><span>(</span><span>mem</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L25" data-line-number="25"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC25"><span>sw</span><span>.</span><span>Stop</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L26" data-line-number="26"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC26"></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L27" data-line-number="27"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC27"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>.</span><span>TotalSeconds</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L28" data-line-number="28"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC28"><span>}</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L29" data-line-number="29"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC29"></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L30" data-line-number="30"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC30"><span>[</span><span>Serializable</span><span>]</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L31" data-line-number="31"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC31"><span>private</span> <span>class</span> <span>Book</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L32" data-line-number="32"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC32"><span>{</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L33" data-line-number="33"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC33"><span>public</span> <span>string</span> <span>Name</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L34" data-line-number="34"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC34"><span>public</span> <span>string</span> <span>Id</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L35" data-line-number="35"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC35"><span>}</span></td></tr><tr><td id="file-perfblog06062017_binaryformatter_deserialize-cs-L36" data-line-number="36"></td><td id="file-perfblog06062017_binaryformatter_deserialize-cs-LC36"><span>}</span></td></tr></tbody></table>

On .NET 4.7, this code outputs results like:

76.677144

whereas on .NET Core 2.0, it outputs results like:

6.4044694

showing an ~12x throughput improvement for this case. In other words, it’s able to deal with much larger serialized inputs more efficiently.

#### Text Processing

Another very common form of computation in .NET applications is the processing of text, and a large number of improvements have gone in here, at various levels of the stack.

Consider [Regex](https://docs.microsoft.com/dotnet/api/system.text.regularexpressions.regex). This type is commonly used to validate and parse data from input text. Here’s an example that uses [Regex.IsMatch](https://docs.microsoft.com/dotnet/api/system.text.regularexpressions.regex.ismatch) to repeatedly match phone numbers:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_RegexIsMatch.cs"><tbody><tr><td id="file-perfblog06062017_regexismatch-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_regexismatch-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_regexismatch-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_regexismatch-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Text</span><span>.</span><span>RegularExpressions</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_regexismatch-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_regexismatch-cs-LC5"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_regexismatch-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_regexismatch-cs-LC7"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_regexismatch-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_regexismatch-cs-LC9"><span>var</span> <span>sw</span> <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_regexismatch-cs-LC10"><span>int</span> <span>gen0</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_regexismatch-cs-LC11"><span>sw</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_regexismatch-cs-LC12"></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_regexismatch-cs-LC13"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>10_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_regexismatch-cs-LC14"><span>{</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_regexismatch-cs-LC15"><span>Regex</span><span>.</span><span>IsMatch</span><span>(</span><span>"555-867-5309"</span><span>,</span> <span>@"^\d{3}-\d{3}-\d{4}$"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_regexismatch-cs-LC16"><span>}</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_regexismatch-cs-LC17"></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_regexismatch-cs-LC18"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span><span>$</span>"Elapsed=<span>{</span><span>sw</span><span>.</span><span>Elapsed</span><span>}</span> Gen0=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span> <span>-</span> <span>gen0</span><span>}</span>"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_regexismatch-cs-LC19"><span>}</span></td></tr><tr><td id="file-perfblog06062017_regexismatch-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_regexismatch-cs-LC20"><span>}</span></td></tr></tbody></table>

On my machine on .NET 4.7, I get results like:

Elapsed=00:00:05.4367262 Gen0=820 Gen1=0 Gen2=0

whereas with .NET Core 2.0, I get results like:

Elapsed=00:00:04.0231373 Gen0=248

That’s an ~25% improvement in throughput and an ~70% reduction in allocation / garbage collections, due to a small change in PR [dotnet/corefx #231](https://github.com/dotnet/corefx/pull/231) that made a fix to how some data is cached.

Another example of text processing is in various forms of encoding and decoding, such as URL decoding via [WebUtility.UrlDecode](https://docs.microsoft.com/dotnet/api/system.net.webutility.urldecode). It’s often the case in decoding methods like this one that the input doesn’t actually need any decoding, but the input is still passed through the decoder in case it does. Thanks to PR [dotnet/corefx #7671](https://github.com/dotnet/corefx/pull/7671) from [hughbe](https://github.com/hughbe), this case has been optimized. So, for example, with this program:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_WebUtility_UrlDecode.cs"><tbody><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Net</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC5"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC7"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC9"><span>var</span> <span>sw</span> <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC10"><span>int</span> <span>gen0</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC11"><span>sw</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC12"></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC13"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>10_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC14"><span>{</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC15"><span>WebUtility</span><span>.</span><span>UrlDecode</span><span>(</span><span>"abcdefghijklmnopqrstuvwxyz"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC16"><span>}</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC17"></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC18"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span><span>$</span>"Elapsed=<span>{</span><span>sw</span><span>.</span><span>Elapsed</span><span>}</span> Gen0=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span> <span>-</span> <span>gen0</span><span>}</span>"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC19"><span>}</span></td></tr><tr><td id="file-perfblog06062017_webutility_urldecode-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_webutility_urldecode-cs-LC20"><span>}</span></td></tr></tbody></table>

on .NET 4.7, I see the following output:

Elapsed=00:00:01.6742583 Gen0=648

whereas on .NET Core 2.0, I see this output:

Elapsed=00:00:01.2255288 Gen0=133

Other forms of encoding and decoding have also been improved. For example, [dotnet/coreclr #10124](https://github.com/dotnet/coreclr/pull/10124) optimized the loops involved in using some of the built-in [Encoding](https://docs.microsoft.com/dotnet/api/system.text.encoding)\-derived types. So, for example, this code that repeatedly encodes an ASCII input string as UTF8:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_Encoding_UTF8_GetBytes.cs"><tbody><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Linq</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>Text</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC5"></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC6"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC7"><span>{</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC8"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC9"><span>{</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC10"><span>string</span> <span>s</span> <span>=</span> <span>new</span> <span>string</span><span>(</span><span>Enumerable</span><span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span> <span>1024</span><span>)</span><span>.</span><span>Select</span><span>(</span>i <span>=&gt;</span> <span>(</span><span>char</span><span>)</span><span>(</span><span>'a'</span> <span>+</span> <span>i</span><span>)</span><span>)</span><span>.</span><span>ToArray</span><span>(</span><span>)</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC11"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC12"><span>{</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC13"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC14"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>1_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC15"><span>{</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC16"><span>byte</span><span>[</span><span>]</span> <span>data</span> <span>=</span> <span>Encoding</span><span>.</span><span>UTF8</span><span>.</span><span>GetBytes</span><span>(</span><span>s</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC17"><span>}</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC18"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC19"><span>}</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC20"><span>}</span></td></tr><tr><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_encoding_utf8_getbytes-cs-LC21"><span>}</span></td></tr></tbody></table>

on .NET 4.7 produces output for me like:

00:00:02.4028829 00:00:02.3743152 00:00:02.3401392 00:00:02.4024785 00:00:02.3550876

and on .NET Core 2.0 produces output for me like:

00:00:01.6133550 00:00:01.5915718 00:00:01.5759625 00:00:01.6070851 00:00:01.6070767

These kinds of improvements extend as well to general Parse and ToString methods in .NET for converting between strings and other representations. For example, it’s fairly common to use enums to represent various kinds of state, and to use [Enum.Parse](https://docs.microsoft.com/dotnet/api/system.enum.parse) to parse a string into a corresponding [Enum](https://docs.microsoft.com/dotnet/api/system.enum). PR [dotnet/coreclr #2933](https://github.com/dotnet/coreclr/pull/2933) helped to improve this. Consider the following code:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_EnumParse.cs"><tbody><tr><td id="file-perfblog06062017_enumparse-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_enumparse-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_enumparse-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_enumparse-cs-LC3"></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_enumparse-cs-LC4"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_enumparse-cs-LC5"><span>{</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_enumparse-cs-LC6"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_enumparse-cs-LC7"><span>{</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_enumparse-cs-LC8"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_enumparse-cs-LC9"><span>{</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_enumparse-cs-LC10"><span>var</span> <span>sw</span> <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_enumparse-cs-LC11"><span>int</span> <span>gen0</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_enumparse-cs-LC12"><span>sw</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_enumparse-cs-LC13"></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_enumparse-cs-LC14"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>2_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_enumparse-cs-LC15"><span>{</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_enumparse-cs-LC16"><span>Enum</span><span>.</span><span>Parse</span><span>(</span><span>typeof</span><span>(</span><span>Colors</span><span>)</span><span>,</span> <span>"Red, Orange, Yellow, Green, Blue"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_enumparse-cs-LC17"><span>}</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_enumparse-cs-LC18"></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_enumparse-cs-LC19"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span><span>$</span>"Elapsed=<span>{</span><span>sw</span><span>.</span><span>Elapsed</span><span>}</span> Gen0=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span> <span>-</span> <span>gen0</span><span>}</span>"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_enumparse-cs-LC20"><span>}</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_enumparse-cs-LC21"><span>}</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_enumparse-cs-LC22"></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_enumparse-cs-LC23"><span>[</span><span>Flags</span><span>]</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_enumparse-cs-LC24"><span>private</span> <span>enum</span> <span>Colors</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L25" data-line-number="25"></td><td id="file-perfblog06062017_enumparse-cs-LC25"><span>{</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L26" data-line-number="26"></td><td id="file-perfblog06062017_enumparse-cs-LC26"><span>Red</span> <span>=</span> <span>0x1</span><span>,</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L27" data-line-number="27"></td><td id="file-perfblog06062017_enumparse-cs-LC27"><span>Orange</span> <span>=</span> <span>0x2</span><span>,</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L28" data-line-number="28"></td><td id="file-perfblog06062017_enumparse-cs-LC28"><span>Yellow</span> <span>=</span> <span>0x4</span><span>,</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L29" data-line-number="29"></td><td id="file-perfblog06062017_enumparse-cs-LC29"><span>Green</span> <span>=</span> <span>0x8</span><span>,</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L30" data-line-number="30"></td><td id="file-perfblog06062017_enumparse-cs-LC30"><span>Blue</span> <span>=</span> <span>0x10</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L31" data-line-number="31"></td><td id="file-perfblog06062017_enumparse-cs-LC31"><span>}</span></td></tr><tr><td id="file-perfblog06062017_enumparse-cs-L32" data-line-number="32"></td><td id="file-perfblog06062017_enumparse-cs-LC32"><span>}</span></td></tr></tbody></table>

On .NET 4.7, I get results like:

Elapsed=00:00:00.9529354 Gen0=293 Elapsed=00:00:00.9422960 Gen0=294 Elapsed=00:00:00.9419024 Gen0=294 Elapsed=00:00:00.9417014 Gen0=294 Elapsed=00:00:00.9514724 Gen0=293

and on .NET Core 2.0, I get results like:

Elapsed=00:00:00.6448327 Gen0=11 Elapsed=00:00:00.6438907 Gen0=11 Elapsed=00:00:00.6285656 Gen0=12 Elapsed=00:00:00.6286561 Gen0=11 Elapsed=00:00:00.6294286 Gen0=12

so not only an ~33% improvement in throughput, but also an ~25x reduction in allocations and associated garbage collections.

Or consider PRs [dotnet/coreclr #7836](https://github.com/dotnet/coreclr/pull/7836) and [dotnet/coreclr #7891](https://github.com/dotnet/coreclr/pull/7891), which improved [DateTime.ToString](https://docs.microsoft.com/dotnet/api/system.datetime.tostring) with formats “o” (the round-trip date/time pattern) and “r” (the RFC1123 pattern), respectively. The result is that given code like this:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_DateTime_ToString.cs"><tbody><tr><td id="file-perfblog06062017_datetime_tostring-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC3"></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC4"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC5"><span>{</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC6"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC7"><span>{</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC8"><span>var</span> <span>dt</span> <span>=</span> <span>DateTime</span><span>.</span><span>Now</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC9"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC10"><span>{</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC11"><span>var</span> <span>sw</span> <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC12"><span>int</span> <span>gen0</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC13"><span>sw</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC14"></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC15"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>2_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC16"><span>{</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC17"><span>dt</span><span>.</span><span>ToString</span><span>(</span><span>"o"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC18"><span>dt</span><span>.</span><span>ToString</span><span>(</span><span>"r"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC19"><span>}</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC20"></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC21"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span><span>$</span>"Elapsed=<span>{</span><span>sw</span><span>.</span><span>Elapsed</span><span>}</span> Gen0=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span> <span>-</span> <span>gen0</span><span>}</span>"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC22"><span>}</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC23"><span>}</span></td></tr><tr><td id="file-perfblog06062017_datetime_tostring-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_datetime_tostring-cs-LC24"><span>}</span></td></tr></tbody></table>

on .NET 4.7 I see output like:

Elapsed=00:00:03.7552059 Gen0=949 Elapsed=00:00:03.6992357 Gen0=950 Elapsed=00:00:03.5459498 Gen0=950 Elapsed=00:00:03.5565029 Gen0=950 Elapsed=00:00:03.5388134 Gen0=950

and on .NET Core 2.0 output like:

Elapsed=00:00:01.3588804 Gen0=87 Elapsed=00:00:01.3932658 Gen0=88 Elapsed=00:00:01.3607030 Gen0=88 Elapsed=00:00:01.3675958 Gen0=87 Elapsed=00:00:01.3546522 Gen0=88

That’s an almost 3x increase in throughput and a whopping ~90% reduction in allocations / garbage collections.

Of course, there’s lots of custom text processing done in .NET applications, beyond using built in types like [Regex](https://docs.microsoft.com/dotnet/api/system.text.regularexpressions.regex)/[Encoding](https://docs.microsoft.com/dotnet/api/system.text.encoding) and built-in operations like Parse and ToString, often built directly on top of string, and lots of improvements have gone into operations on [String](https://docs.microsoft.com/dotnet/api/system.string) itself.

For example, [String.IndexOf](https://docs.microsoft.com/dotnet/api/system.string.indexof) is very commonly used to find characters in strings. [IndexOf](https://docs.microsoft.com/dotnet/api/system.string.indexof) was improved in [dotnet/coreclr #5327](https://github.com/dotnet/coreclr/pull/5327) by [bbowyersmyth](https://github.com/bbowyersmyth), who’s submitted a bunch of performance improvements for [String](https://docs.microsoft.com/dotnet/api/system.string). So this example:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_String_IndexOf_Char.cs"><tbody><tr><td id="file-perfblog06062017_string_indexof_char-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Linq</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC5"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC7"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC9"><span>string</span> <span>s</span> <span>=</span> <span>string</span><span>.</span><span>Concat</span><span>(</span><span>Enumerable</span><span>.</span><span>Repeat</span><span>(</span><span>"a"</span><span>,</span> <span>100</span><span>)</span><span>)</span> <span>+</span> <span>"b"</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC10"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC11"><span>{</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC12"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC13"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>100_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC14"><span>{</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC15"><span>s</span><span>.</span><span>IndexOf</span><span>(</span><span>'b'</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC16"><span>}</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC17"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC18"><span>}</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC19"><span>}</span></td></tr><tr><td id="file-perfblog06062017_string_indexof_char-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_string_indexof_char-cs-LC20"><span>}</span></td></tr></tbody></table>

on .NET 4.7 produces results for me like this:

00:00:05.9718129 00:00:05.9199793 00:00:06.0203108 00:00:05.9458049 00:00:05.9622262

whereas on .NET Core 2.0 it produces results for me like this:

00:00:03.1283763 00:00:03.0925150 00:00:02.9778923 00:00:03.0782851

for an ~2x improvement in throughput.

Or consider comparing strings. Here’s an example that uses [String.StartsWith](https://docs.microsoft.com/dotnet/api/system.string.startswith) and ordinal comparisons:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_String_StartsWith_Ordinal.cs"><tbody><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Linq</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC5"><span>public</span> <span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC7"><span>public</span> <span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC9"><span>string</span> <span>s</span> <span>=</span> <span>"abcdefghijklmnopqrstuvwxyz"</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC10"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC11"><span>{</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC12"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC13"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>100_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC14"><span>{</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC15"><span>s</span><span>.</span><span>StartsWith</span><span>(</span><span>"abcdefghijklmnopqrstuvwxy-"</span><span>,</span> <span>StringComparison</span><span>.</span><span>Ordinal</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC16"><span>}</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC17"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC18"><span>}</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC19"><span>}</span></td></tr><tr><td id="file-perfblog06062017_string_startswith_ordinal-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_string_startswith_ordinal-cs-LC20"><span>}</span></td></tr></tbody></table>

Thanks to [dotnet/coreclr #2825](https://github.com/dotnet/coreclr/pull/2825), on .NET 4.7 I get results like:

00:00:01.3097317 00:00:01.3072381 00:00:01.3045015 00:00:01.3068244 00:00:01.3210207

and on .NET Core 2.0 results like:

00:00:00.6239002 00:00:00.6150021 00:00:00.6147173 00:00:00.6129136 00:00:00.6099822

It’s quite fun looking through all of the changes that have gone into [String](https://docs.microsoft.com/dotnet/api/system.string), seeing their impact, and thinking about the additional possibilities for more improvements.

#### File System

Thus far I’ve been focusing on various improvements around manipulating data in memory. But lots of the changes that have gone into .NET Core have been about I/O.

Let’s start with files. Here’s an example of asynchronously reading all of the data from one file and writing it to another (using [FileStream](https://docs.microsoft.com/dotnet/api/system.io.filestream)s configured to use async I/O):

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_FileStream_Async_ReadWrite.cs"><tbody><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>IO</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>Threading</span><span>.</span><span>Tasks</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC5"></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC6"><span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC7"><span>{</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC8"><span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span> <span>=&gt;</span> <span>MainAsync</span><span>(</span><span>)</span><span>.</span><span>GetAwaiter</span><span>(</span><span>)</span><span>.</span><span>GetResult</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC9"><span><span>static</span></span> <span>async</span> <span>Task</span> <span>MainAsync</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC10"><span>{</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC11"><span>string</span> <span>inputPath</span> <span>=</span> <span>Path</span><span>.</span><span>GetTempFileName</span><span>(</span><span>)</span><span>,</span> <span>outputPath</span> <span>=</span> <span>Path</span><span>.</span><span>GetTempFileName</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC12"><span>byte</span><span>[</span><span>]</span> <span>data</span> <span>=</span> <span>new</span> <span>byte</span><span>[</span><span>50_000_000</span><span>]</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC13"><span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>NextBytes</span><span>(</span><span>data</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC14"><span>File</span><span>.</span><span>WriteAllBytes</span><span>(</span><span>inputPath</span><span>,</span> <span>data</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC15"></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC16"><span>var</span> <span>sw</span> <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC17"><span>int</span> <span>gen0</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span><span>,</span> <span>gen1</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span><span>,</span> <span>gen2</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC18"><span>sw</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC19"></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC20"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>100</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC21"><span>{</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC22"><span>using</span> <span>(</span><span>var</span> <span>input</span> <span>=</span> <span>new</span> <span>FileStream</span><span>(</span><span>inputPath</span><span>,</span> <span>FileMode</span><span>.</span><span>Open</span><span>,</span> <span>FileAccess</span><span>.</span><span>Read</span><span>,</span> <span>FileShare</span><span>.</span><span>Read</span><span>,</span> <span>0x1000</span><span>,</span> <span>useAsync</span><span>:</span> <span>true</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC23"><span>using</span> <span>(</span><span>var</span> <span>output</span> <span>=</span> <span>new</span> <span>FileStream</span><span>(</span><span>outputPath</span><span>,</span> <span>FileMode</span><span>.</span><span>Create</span><span>,</span> <span>FileAccess</span><span>.</span><span>ReadWrite</span><span>,</span> <span>FileShare</span><span>.</span><span>None</span><span>,</span> <span>0x1000</span><span>,</span> <span>useAsync</span><span>:</span> <span>true</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC24"><span>{</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L25" data-line-number="25"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC25"><span>await</span> <span>input</span><span>.</span><span>CopyToAsync</span><span>(</span><span>output</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L26" data-line-number="26"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC26"><span>}</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L27" data-line-number="27"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC27"><span>}</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L28" data-line-number="28"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC28"></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L29" data-line-number="29"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC29"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span><span>$</span>"Elapsed=<span>{</span><span>sw</span><span>.</span><span>Elapsed</span><span>}</span> Gen0=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span> <span>-</span> <span>gen0</span><span>}</span> Gen1=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span> <span>-</span> <span>gen1</span><span>}</span> Gen2=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span> <span>-</span> <span>gen2</span><span>}</span>"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L30" data-line-number="30"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC30"><span>}</span></td></tr><tr><td id="file-perfblog06062017_filestream_async_readwrite-cs-L31" data-line-number="31"></td><td id="file-perfblog06062017_filestream_async_readwrite-cs-LC31"><span>}</span></td></tr></tbody></table>

A bunch of PRs have gone into reducing the overheads involved in [FileStream](https://docs.microsoft.com/dotnet/api/system.io.filestream), such as [dotnet/corefx #11569](https://github.com/dotnet/corefx/pull/11569) which adds a specialized CopyToAsync implementation, and [dotnet/corefx #2929](https://github.com/dotnet/corefx/pull/2929) which improves how asynchronous writes are handled, and so when running this on .NET 4.7 I get results like:

Elapsed=00:00:09.4070345 Gen0=14 Gen1=7 Gen2=1

and on .NET Core 2.0, results like:

Elapsed=00:00:06.4286604 Gen0=4 Gen1=1 Gen2=1

#### Networking

Networking is a big area of focus now, and likely will be even more so moving forward. A good amount of effort is being applied to optimizing and tuning the lower-levels of the networking stack, so that higher-level components can be built efficiently.

One such change that has a big impact is PR [dotnet/corefx #15141](https://github.com/dotnet/corefx/pull/15141). [SocketAsyncEventArgs](https://docs.microsoft.com/dotnet/api/system.net.sockets.socketasynceventargs) is at the center of a bunch of asynchronous operations on [Socket](https://docs.microsoft.com/dotnet/api/system.net.sockets.socket), and it supports a synchronous completion model whereby asynchronous operations that actually complete synchronously can avoid costs associated with asynchronous completions. However, the implementation in .NET 4.7 only ever synchronously completes operations that fail; the aforementioned PR fixed the implementation to allow for synchronous completions of all async operations on sockets. The impact of this is very obvious in code like the following:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_Sockets_SynchronousCompletion_Send_Receive.cs"><tbody><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Net</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>Net</span><span>.</span><span>Sockets</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC5"><span>using</span> <span>System</span><span>.</span><span>Threading</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC6"><span>using</span> <span>System</span><span>.</span><span>Threading</span><span>.</span><span>Tasks</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC7"></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC8"><span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC9"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC10"><span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC11"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC12"><span>using</span> <span>(</span><span>Socket</span> <span>listener</span> <span>=</span> <span>new</span> <span>Socket</span><span>(</span><span>AddressFamily</span><span>.</span><span>InterNetwork</span><span>,</span> <span>SocketType</span><span>.</span><span>Stream</span><span>,</span> <span>ProtocolType</span><span>.</span><span>Tcp</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC13"><span>using</span> <span>(</span><span>Socket</span> <span>client</span> <span>=</span> <span>new</span> <span>Socket</span><span>(</span><span>AddressFamily</span><span>.</span><span>InterNetwork</span><span>,</span> <span>SocketType</span><span>.</span><span>Stream</span><span>,</span> <span>ProtocolType</span><span>.</span><span>Tcp</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC14"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC15"><span>listener</span><span>.</span><span>Bind</span><span>(</span><span>new</span> <span>IPEndPoint</span><span>(</span><span>IPAddress</span><span>.</span><span>Loopback</span><span>,</span> <span>0</span><span>)</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC16"><span>listener</span><span>.</span><span>Listen</span><span>(</span><span>1</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC17"></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC18"><span>Task</span> <span>connectTask</span> <span>=</span> <span>Task</span><span>.</span><span>Run</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>Connect</span><span>(</span><span>listener</span><span>.</span><span>LocalEndPoint</span><span>)</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC19"><span>using</span> <span>(</span><span>Socket</span> <span>server</span> <span>=</span> <span>listener</span><span>.</span><span>Accept</span><span>(</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC20"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC21"><span>connectTask</span><span>.</span><span>Wait</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC22"></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC23"><span>using</span> <span>(</span><span>var</span> <span>clientAre</span> <span>=</span> <span>new</span> <span>AutoResetEvent</span><span>(</span><span>false</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC24"><span>using</span> <span>(</span><span>var</span> <span>clientSaea</span> <span>=</span> <span>new</span> <span>SocketAsyncEventArgs</span><span>(</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L25" data-line-number="25"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC25"><span>using</span> <span>(</span><span>var</span> <span>serverAre</span> <span>=</span> <span>new</span> <span>AutoResetEvent</span><span>(</span><span>false</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L26" data-line-number="26"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC26"><span>using</span> <span>(</span><span>var</span> <span>serverSaea</span> <span>=</span> <span>new</span> <span>SocketAsyncEventArgs</span><span>(</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L27" data-line-number="27"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC27"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L28" data-line-number="28"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC28"><span>byte</span><span>[</span><span>]</span> <span>sendBuffer</span> <span>=</span> <span>new</span> <span>byte</span><span>[</span><span>1000</span><span>]</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L29" data-line-number="29"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC29"><span>clientSaea</span><span>.</span><span>SetBuffer</span><span>(</span><span>sendBuffer</span><span>,</span> <span>0</span><span>,</span> <span>sendBuffer</span><span>.</span><span>Length</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L30" data-line-number="30"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC30"><span>clientSaea</span><span>.</span><span>Completed</span> <span>+=</span> <span>delegate</span> <span>{</span> <span>clientAre</span><span>.</span><span>Set</span><span>(</span><span>)</span><span>;</span> <span>}</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L31" data-line-number="31"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC31"></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L32" data-line-number="32"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC32"><span>byte</span><span>[</span><span>]</span> <span>receiveBuffer</span> <span>=</span> <span>new</span> <span>byte</span><span>[</span><span>1000</span><span>]</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L33" data-line-number="33"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC33"><span>serverSaea</span><span>.</span><span>SetBuffer</span><span>(</span><span>receiveBuffer</span><span>,</span> <span>0</span><span>,</span> <span>receiveBuffer</span><span>.</span><span>Length</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L34" data-line-number="34"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC34"><span>serverSaea</span><span>.</span><span>Completed</span> <span>+=</span> <span>delegate</span> <span>{</span> <span>serverAre</span><span>.</span><span>Set</span><span>(</span><span>)</span><span>;</span> <span>}</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L35" data-line-number="35"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC35"></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L36" data-line-number="36"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC36"><span>var</span> <span>sw</span> <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L37" data-line-number="37"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC37"><span>int</span> <span>gen0</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span><span>,</span> <span>gen1</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span><span>,</span> <span>gen2</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L38" data-line-number="38"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC38"><span>sw</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L39" data-line-number="39"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC39"></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L40" data-line-number="40"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC40"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>1_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L41" data-line-number="41"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC41"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L42" data-line-number="42"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC42"><span>if</span> <span>(</span><span>client</span><span>.</span><span>SendAsync</span><span>(</span><span>clientSaea</span><span>)</span><span>)</span> <span>clientAre</span><span>.</span><span>WaitOne</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L43" data-line-number="43"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC43"><span>if</span> <span>(</span><span>clientSaea</span><span>.</span><span>SocketError</span> <span>!=</span> <span>SocketError</span><span>.</span><span>Success</span><span>)</span> <span>throw</span> <span>new</span> <span>SocketException</span><span>(</span><span>(</span><span>int</span><span>)</span><span>clientSaea</span><span>.</span><span>SocketError</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L44" data-line-number="44"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC44"></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L45" data-line-number="45"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC45"><span>if</span> <span>(</span><span>server</span><span>.</span><span>ReceiveAsync</span><span>(</span><span>serverSaea</span><span>)</span><span>)</span> <span>serverAre</span><span>.</span><span>WaitOne</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L46" data-line-number="46"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC46"><span>if</span> <span>(</span><span>serverSaea</span><span>.</span><span>SocketError</span> <span>!=</span> <span>SocketError</span><span>.</span><span>Success</span><span>)</span> <span>throw</span> <span>new</span> <span>SocketException</span><span>(</span><span>(</span><span>int</span><span>)</span><span>clientSaea</span><span>.</span><span>SocketError</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L47" data-line-number="47"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC47"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L48" data-line-number="48"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC48"></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L49" data-line-number="49"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC49"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span><span>$</span>"Elapsed=<span>{</span><span>sw</span><span>.</span><span>Elapsed</span><span>}</span> Gen0=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span> <span>-</span> <span>gen0</span><span>}</span> Gen1=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span> <span>-</span> <span>gen1</span><span>}</span> Gen2=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span> <span>-</span> <span>gen2</span><span>}</span>"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L50" data-line-number="50"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC50"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L51" data-line-number="51"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC51"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L52" data-line-number="52"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC52"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L53" data-line-number="53"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC53"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-L54" data-line-number="54"></td><td id="file-perfblog06062017_sockets_synchronouscompletion_send_receive-cs-LC54"><span>}</span></td></tr></tbody></table>

This program creates two connected sockets, and then writes 1,000,000 times to one socket and receives on the other, in both cases using asynchronous methods but where the vast majority (if not all) of the operations will complete synchronously. On .NET 4.7 I see results like:

Elapsed=00:00:20.5272910 Gen0=42 Gen1=2 Gen2=0

whereas on .NET Core 2.0 with most of these operations able to complete synchronously, I see results instead like:

Elapsed=00:00:05.6197060 Gen0=0 Gen1=0 Gen2=0

Not only do such improvements accrue to components using sockets directly, but also to using sockets indirectly via higher-level components, and other PRs have resulted in additional performance increases in higher-level components, such as [NetworkStream](https://docs.microsoft.com/dotnet/api/system.net.sockets.networkstream). For example, PR [dotnet/corefx #16502](https://github.com/dotnet/corefx/pull/16502) re-implemented Socket’s Task-based SendAsync and ReceiveAsync operations on top of SocketAsyncEventArgs and then allowed those to be used from [NetworkStream](https://docs.microsoft.com/dotnet/api/system.net.sockets.networkstream).[Read](https://docs.microsoft.com/dotnet/api/system.net.sockets.networkstream.readasync)/[WriteAsync](https://docs.microsoft.com/dotnet/api/system.net.sockets.networkstream.writeasync), and PR [dotnet/corefx #12664](https://github.com/dotnet/corefx/pull/12664) added a specialized [CopyToAsync](https://docs.microsoft.com/dotnet/api/system.io.stream.copytoasync) override to support more efficiently reading the data from a [NetworkStream](https://docs.microsoft.com/dotnet/api/system.net.sockets.networkstream) and copying it out to some other stream. Those changes have a very measurable impact on [NetworkStream](https://docs.microsoft.com/dotnet/api/system.net.sockets.networkstream) throughput and allocations. Consider this example:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_NetworkStream_WriteAsync_CopyToAsync.cs"><tbody><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>IO</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>Net</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC5"><span>using</span> <span>System</span><span>.</span><span>Net</span><span>.</span><span>Sockets</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC6"><span>using</span> <span>System</span><span>.</span><span>Threading</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC7"><span>using</span> <span>System</span><span>.</span><span>Threading</span><span>.</span><span>Tasks</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC8"></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC9"><span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC10"><span>{</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC11"><span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span> <span>=&gt;</span> <span>MainAsync</span><span>(</span><span>)</span><span>.</span><span>GetAwaiter</span><span>(</span><span>)</span><span>.</span><span>GetResult</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC12"><span><span>static</span></span> <span>async</span> <span>Task</span> <span>MainAsync</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC13"><span>{</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC14"><span>using</span> <span>(</span><span>Socket</span> <span>listener</span> <span>=</span> <span>new</span> <span>Socket</span><span>(</span><span>AddressFamily</span><span>.</span><span>InterNetwork</span><span>,</span> <span>SocketType</span><span>.</span><span>Stream</span><span>,</span> <span>ProtocolType</span><span>.</span><span>Tcp</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC15"><span>using</span> <span>(</span><span>Socket</span> <span>client</span> <span>=</span> <span>new</span> <span>Socket</span><span>(</span><span>AddressFamily</span><span>.</span><span>InterNetwork</span><span>,</span> <span>SocketType</span><span>.</span><span>Stream</span><span>,</span> <span>ProtocolType</span><span>.</span><span>Tcp</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC16"><span>{</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC17"><span>listener</span><span>.</span><span>Bind</span><span>(</span><span>new</span> <span>IPEndPoint</span><span>(</span><span>IPAddress</span><span>.</span><span>Loopback</span><span>,</span> <span>0</span><span>)</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC18"><span>listener</span><span>.</span><span>Listen</span><span>(</span><span>1</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC19"></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC20"><span>Task</span> <span>connectTask</span> <span>=</span> <span>Task</span><span>.</span><span>Run</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>Connect</span><span>(</span><span>listener</span><span>.</span><span>LocalEndPoint</span><span>)</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC21"><span>using</span> <span>(</span><span>Socket</span> <span>server</span> <span>=</span> <span>listener</span><span>.</span><span>Accept</span><span>(</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC22"><span>{</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC23"><span>await</span> <span>connectTask</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC24"></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L25" data-line-number="25"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC25"><span>using</span> <span>(</span><span>var</span> <span>serverStream</span> <span>=</span> <span>new</span> <span>NetworkStream</span><span>(</span><span>server</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L26" data-line-number="26"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC26"><span>using</span> <span>(</span><span>var</span> <span>clientStream</span> <span>=</span> <span>new</span> <span>NetworkStream</span><span>(</span><span>client</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L27" data-line-number="27"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC27"><span>{</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L28" data-line-number="28"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC28"><span>Task</span> <span>serverCopyAll</span> <span>=</span> <span>serverStream</span><span>.</span><span>CopyToAsync</span><span>(</span><span>Stream</span><span>.</span><span>Null</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L29" data-line-number="29"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC29"></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L30" data-line-number="30"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC30"><span>byte</span><span>[</span><span>]</span> <span>data</span> <span>=</span> <span>new</span> <span>byte</span><span>[</span><span>1024</span><span>]</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L31" data-line-number="31"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC31"><span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>NextBytes</span><span>(</span><span>data</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L32" data-line-number="32"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC32"></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L33" data-line-number="33"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC33"><span>var</span> <span>sw</span> <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L34" data-line-number="34"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC34"><span>int</span> <span>gen0</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span><span>,</span> <span>gen1</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span><span>,</span> <span>gen2</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L35" data-line-number="35"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC35"><span>sw</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L36" data-line-number="36"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC36"></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L37" data-line-number="37"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC37"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>1_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L38" data-line-number="38"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC38"><span>{</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L39" data-line-number="39"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC39"><span>await</span> <span>clientStream</span><span>.</span><span>WriteAsync</span><span>(</span><span>data</span><span>,</span> <span>0</span><span>,</span> <span>data</span><span>.</span><span>Length</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L40" data-line-number="40"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC40"><span>}</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L41" data-line-number="41"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC41"><span>client</span><span>.</span><span>Shutdown</span><span>(</span><span>SocketShutdown</span><span>.</span><span>Send</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L42" data-line-number="42"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC42"><span>serverCopyAll</span><span>.</span><span>Wait</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L43" data-line-number="43"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC43"><span>sw</span><span>.</span><span>Stop</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L44" data-line-number="44"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC44"></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L45" data-line-number="45"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC45"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span><span>$</span>"Elapsed=<span>{</span><span>sw</span><span>.</span><span>Elapsed</span><span>}</span> Gen0=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span> <span>-</span> <span>gen0</span><span>}</span> Gen1=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span> <span>-</span> <span>gen1</span><span>}</span> Gen2=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span> <span>-</span> <span>gen2</span><span>}</span>"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L46" data-line-number="46"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC46"><span>}</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L47" data-line-number="47"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC47"><span>}</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L48" data-line-number="48"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC48"><span>}</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L49" data-line-number="49"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC49"><span>}</span></td></tr><tr><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-L50" data-line-number="50"></td><td id="file-perfblog06062017_networkstream_writeasync_copytoasync-cs-LC50"><span>}</span></td></tr></tbody></table>

As with the previous [Socket](https://docs.microsoft.com/dotnet/api/system.net.sockets.socket)s one, we’re creating two connected sockets. We’re then wrapping those in [NetworkStream](https://docs.microsoft.com/dotnet/api/system.net.sockets.networkstream)s. On one of the streams we write 1K of data a million times, and on the other stream we read out all of its data via a [CopyToAsync](https://docs.microsoft.com/dotnet/api/system.io.stream.copytoasync) operation. On .NET 4.7, I get output like the following:

Elapsed=00:00:24.7827947 Gen0=220 Gen1=3 Gen2=0

whereas on .NET Core 2.0, the time is cut by 5x, and garbage collections are reduced effectively to zero:

Elapsed=00:00:04.9452962 Gen0=0 Gen1=0 Gen2=0

Further optimizations have gone into other networking-related components. For example, [SslStream](https://docs.microsoft.com/dotnet/api/system.net.security.sslstream) is often wrapped around a [NetworkStream](https://docs.microsoft.com/dotnet/api/system.net.sockets.networkstream) in order to add SSL to a connection. We can see the impact of these changes as well as others in an example like the following, which just adds usage of [SslStream](https://docs.microsoft.com/dotnet/api/system.net.security.sslstream) on top of the previous [NetworkStream](https://docs.microsoft.com/dotnet/api/system.net.sockets.networkstream) example:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_SslStream_NetworkStream.cs"><tbody><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>IO</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC4"><span>using</span> <span>System</span><span>.</span><span>Linq</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC5"><span>using</span> <span>System</span><span>.</span><span>Net</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC6"><span>using</span> <span>System</span><span>.</span><span>Net</span><span>.</span><span>Security</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC7"><span>using</span> <span>System</span><span>.</span><span>Net</span><span>.</span><span>Sockets</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC8"><span>using</span> <span>System</span><span>.</span><span>Security</span><span>.</span><span>Authentication</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC9"><span>using</span> <span>System</span><span>.</span><span>Security</span><span>.</span><span>Cryptography</span><span>.</span><span>X509Certificates</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC10"><span>using</span> <span>System</span><span>.</span><span>Threading</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC11"><span>using</span> <span>System</span><span>.</span><span>Threading</span><span>.</span><span>Tasks</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC12"></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC13"><span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC14"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC15"><span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span> <span>=&gt;</span> <span>MainAsync</span><span>(</span><span>)</span><span>.</span><span>GetAwaiter</span><span>(</span><span>)</span><span>.</span><span>GetResult</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC16"><span><span>static</span></span> <span>async</span> <span>Task</span> <span>MainAsync</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC17"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC18"><span>var</span> <span>certCollection</span> <span>=</span> <span>new</span> <span>X509Certificate2Collection</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC19"><span>certCollection</span><span>.</span><span>Import</span><span>(</span><span>"testcert.pfx"</span><span>,</span> <span>"testcertificate"</span><span>,</span> <span>X509KeyStorageFlags</span><span>.</span><span>DefaultKeySet</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC20"><span>var</span> <span>serverCert</span> <span>=</span> <span>certCollection</span><span>.</span><span>Cast</span><span>&lt;</span><span>X509Certificate2</span><span>&gt;</span><span>(</span><span>)</span><span>.</span><span>First</span><span>(</span>c <span>=&gt;</span> <span>c</span><span>.</span><span>HasPrivateKey</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC21"></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC22"><span>using</span> <span>(</span><span>Socket</span> <span>listener</span> <span>=</span> <span>new</span> <span>Socket</span><span>(</span><span>AddressFamily</span><span>.</span><span>InterNetwork</span><span>,</span> <span>SocketType</span><span>.</span><span>Stream</span><span>,</span> <span>ProtocolType</span><span>.</span><span>Tcp</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC23"><span>using</span> <span>(</span><span>Socket</span> <span>client</span> <span>=</span> <span>new</span> <span>Socket</span><span>(</span><span>AddressFamily</span><span>.</span><span>InterNetwork</span><span>,</span> <span>SocketType</span><span>.</span><span>Stream</span><span>,</span> <span>ProtocolType</span><span>.</span><span>Tcp</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC24"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L25" data-line-number="25"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC25"><span>listener</span><span>.</span><span>Bind</span><span>(</span><span>new</span> <span>IPEndPoint</span><span>(</span><span>IPAddress</span><span>.</span><span>Loopback</span><span>,</span> <span>0</span><span>)</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L26" data-line-number="26"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC26"><span>listener</span><span>.</span><span>Listen</span><span>(</span><span>1</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L27" data-line-number="27"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC27"></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L28" data-line-number="28"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC28"><span>Task</span> <span>connectTask</span> <span>=</span> <span>Task</span><span>.</span><span>Run</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>Connect</span><span>(</span><span>listener</span><span>.</span><span>LocalEndPoint</span><span>)</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L29" data-line-number="29"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC29"><span>using</span> <span>(</span><span>Socket</span> <span>server</span> <span>=</span> <span>listener</span><span>.</span><span>Accept</span><span>(</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L30" data-line-number="30"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC30"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L31" data-line-number="31"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC31"><span>await</span> <span>connectTask</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L32" data-line-number="32"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC32"></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L33" data-line-number="33"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC33"><span>using</span> <span>(</span><span>var</span> <span>serverStream</span> <span>=</span> <span>new</span> <span>SslStream</span><span>(</span><span>new</span> <span>NetworkStream</span><span>(</span><span>server</span><span>,</span> <span>true</span><span>)</span><span>,</span> <span>false</span><span>,</span> <span>delegate</span> <span>{</span> <span>return</span> <span>true</span><span>;</span> <span>}</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L34" data-line-number="34"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC34"><span>using</span> <span>(</span><span>var</span> <span>clientStream</span> <span>=</span> <span>new</span> <span>SslStream</span><span>(</span><span>new</span> <span>NetworkStream</span><span>(</span><span>client</span><span>,</span> <span>true</span><span>)</span><span>,</span> <span>false</span><span>,</span> <span>delegate</span> <span>{</span> <span>return</span> <span>true</span><span>;</span> <span>}</span><span>)</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L35" data-line-number="35"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC35"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L36" data-line-number="36"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC36"><span>await</span> <span>Task</span><span>.</span><span>WhenAll</span><span>(</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L37" data-line-number="37"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC37"><span>serverStream</span><span>.</span><span>AuthenticateAsServerAsync</span><span>(</span><span>serverCert</span><span>,</span> <span>false</span><span>,</span> <span>SslProtocols</span><span>.</span><span>Tls12</span><span>,</span> <span>false</span><span>)</span><span>,</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L38" data-line-number="38"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC38"><span>clientStream</span><span>.</span><span>AuthenticateAsClientAsync</span><span>(</span><span>"localhost"</span><span>,</span> <span>null</span><span>,</span> <span>SslProtocols</span><span>.</span><span>Tls12</span><span>,</span> <span>false</span><span>)</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L39" data-line-number="39"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC39"></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L40" data-line-number="40"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC40"><span>Task</span> <span>serverCopyAll</span> <span>=</span> <span>serverStream</span><span>.</span><span>CopyToAsync</span><span>(</span><span>Stream</span><span>.</span><span>Null</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L41" data-line-number="41"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC41"></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L42" data-line-number="42"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC42"><span>byte</span><span>[</span><span>]</span> <span>data</span> <span>=</span> <span>new</span> <span>byte</span><span>[</span><span>1024</span><span>]</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L43" data-line-number="43"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC43"><span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>NextBytes</span><span>(</span><span>data</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L44" data-line-number="44"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC44"></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L45" data-line-number="45"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC45"><span>var</span> <span>sw</span> <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L46" data-line-number="46"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC46"><span>int</span> <span>gen0</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span><span>,</span> <span>gen1</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span><span>,</span> <span>gen2</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L47" data-line-number="47"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC47"><span>sw</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L48" data-line-number="48"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC48"></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L49" data-line-number="49"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC49"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>1_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L50" data-line-number="50"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC50"><span>{</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L51" data-line-number="51"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC51"><span>clientStream</span><span>.</span><span>Write</span><span>(</span><span>data</span><span>,</span> <span>0</span><span>,</span> <span>data</span><span>.</span><span>Length</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L52" data-line-number="52"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC52"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L53" data-line-number="53"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC53"><span>clientStream</span><span>.</span><span>Dispose</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L54" data-line-number="54"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC54"></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L55" data-line-number="55"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC55"><span>serverCopyAll</span><span>.</span><span>Wait</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L56" data-line-number="56"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC56"><span>sw</span><span>.</span><span>Stop</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L57" data-line-number="57"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC57"></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L58" data-line-number="58"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC58"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span><span>$</span>"Elapsed=<span>{</span><span>sw</span><span>.</span><span>Elapsed</span><span>}</span> Gen0=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span> <span>-</span> <span>gen0</span><span>}</span> Gen1=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span> <span>-</span> <span>gen1</span><span>}</span> Gen2=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span> <span>-</span> <span>gen2</span><span>}</span>"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L59" data-line-number="59"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC59"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L60" data-line-number="60"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC60"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L61" data-line-number="61"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC61"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L62" data-line-number="62"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC62"><span>}</span></td></tr><tr><td id="file-perfblog06062017_sslstream_networkstream-cs-L63" data-line-number="63"></td><td id="file-perfblog06062017_sslstream_networkstream-cs-LC63"><span>}</span></td></tr></tbody></table>

On .NET 4.7, I get results like the following:

Elapsed=00:00:21.1171962 Gen0=470 Gen1=3 Gen2=1

.NET Core 2.0 includes changes from PRs like [dotnet/corefx #12935](https://github.com/dotnet/corefx/pull/12935) and [dotnet/corefx #13274](https://github.com/dotnet/corefx/pull/13274), both of which together significantly reduce the allocations involved in using [SslStream](https://docs.microsoft.com/dotnet/api/system.net.security.sslstream). When running the same code on .NET Core 2.0, I get results like the following:

Elapsed=00:00:05.6456073 Gen0=74 Gen1=0 Gen2=0

That’s 85% of the garbage collections removed!

#### Concurrency

Not to be left out, lots of improvements have gone into infrastructure and primitives related to concurrency and parallelism.

One of the key focuses here has been the [ThreadPool](https://docs.microsoft.com/dotnet/api/system.threading.threadpool), which is at the heart of the execution of many .NET apps. For example, PR [dotnet/coreclr #3157](https://github.com/dotnet/coreclr/pull/3157) reduced the sizes of some of the objects involved in [QueueUserWorkItem](https://docs.microsoft.com/dotnet/api/system.threading.threadpool.queueuserworkitem), and PR [dotnet/coreclr #9234](https://github.com/dotnet/coreclr/pull/9234) used the previously mentioned rewrite of [ConcurrentQueue<T>](https://docs.microsoft.com/dotnet/api/system.collections.concurrent.concurrentqueue-1) to replace the global queue of the [ThreadPool](https://docs.microsoft.com/dotnet/api/system.threading.threadpool) with one that involves less synchronization and less allocation. The net result in visible in an example like the following:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_ThreadPool_QueueUserWorkItem_ProcessorCount.cs"><tbody><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Threading</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC5"><span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC7"><span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC9"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC10"><span>{</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC11"><span>int</span> <span>remaining</span> <span>=</span> <span>20_000_000</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC12"><span>var</span> <span>mres</span> <span>=</span> <span>new</span> <span>ManualResetEventSlim</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC13"><span>WaitCallback</span> <span>wc</span> <span>=</span> <span>null</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC14"><span>wc</span> <span>=</span> <span>delegate</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC15"><span>{</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC16"><span>if</span> <span>(</span><span>Interlocked</span><span>.</span><span>Decrement</span><span>(</span><span>ref</span> <span>remaining</span><span>)</span> <span>&lt;=</span> <span>0</span><span>)</span> <span>mres</span><span>.</span><span>Set</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC17"><span>else</span> <span>ThreadPool</span><span>.</span><span>QueueUserWorkItem</span><span>(</span><span>wc</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC18"><span>}</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC19"></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC20"><span>var</span> <span>sw</span> <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC21"><span>int</span> <span>gen0</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span><span>,</span> <span>gen1</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span><span>,</span> <span>gen2</span> <span>=</span> <span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC22"><span>sw</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC23"></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC24"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>Environment</span><span>.</span><span>ProcessorCount</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>ThreadPool</span><span>.</span><span>QueueUserWorkItem</span><span>(</span><span>wc</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L25" data-line-number="25"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC25"><span>mres</span><span>.</span><span>Wait</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L26" data-line-number="26"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC26"></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L27" data-line-number="27"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC27"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span><span>$</span>"Elapsed=<span>{</span><span>sw</span><span>.</span><span>Elapsed</span><span>}</span> Gen0=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>0</span><span>)</span> <span>-</span> <span>gen0</span><span>}</span> Gen1=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>1</span><span>)</span> <span>-</span> <span>gen1</span><span>}</span> Gen2=<span>{</span><span>GC</span><span>.</span><span>CollectionCount</span><span>(</span><span>2</span><span>)</span> <span>-</span> <span>gen2</span><span>}</span>"</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L28" data-line-number="28"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC28"><span>}</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L29" data-line-number="29"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC29"><span>}</span></td></tr><tr><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-L30" data-line-number="30"></td><td id="file-perfblog06062017_threadpool_queueuserworkitem_processorcount-cs-LC30"><span>}</span></td></tr></tbody></table>

On .NET 4.7, I see results like the following:

Elapsed=00:00:03.6263995 Gen0=225 Gen1=51 Gen2=16 Elapsed=00:00:03.6304345 Gen0=231 Gen1=62 Gen2=17 Elapsed=00:00:03.6142323 Gen0=225 Gen1=53 Gen2=16 Elapsed=00:00:03.6565384 Gen0=232 Gen1=62 Gen2=16 Elapsed=00:00:03.5999892 Gen0=228 Gen1=62 Gen2=17

whereas on .NET Core 2.0, I see results like the following:

Elapsed=00:00:02.1797508 Gen0=153 Gen1=0 Gen2=0 Elapsed=00:00:02.1188833 Gen0=154 Gen1=0 Gen2=0 Elapsed=00:00:02.1000003 Gen0=153 Gen1=0 Gen2=0 Elapsed=00:00:02.1024852 Gen0=153 Gen1=0 Gen2=0 Elapsed=00:00:02.1044461 Gen0=154 Gen1=1 Gen2=0

That’s both a huge improvement in throughput and a huge reduction in garbage collections for such a core component.

Synchronization primitives have also gotten a boost in .NET Core. For example, [SpinLock](https://docs.microsoft.com/dotnet/api/system.threading.spinlock) is often used by low-level concurrent code trying either to avoid allocating lock objects or minimize the time it takes to acquire a rarely contended lock, and its [TryEnter](https://docs.microsoft.com/dotnet/api/system.threading.spinlock.tryenter) method is often called with a value of 0 in order to only take the lock if it can be taken immediately, or else fail immediately if it can’t, without any spinning. PR [dotnet/coreclr #6952](https://github.com/dotnet/coreclr/pull/6952) improved that fail fast path, as is evident in the following test:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_SpinLock_TryEnter_AlreadyAcquired.cs"><tbody><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC3"><span>using</span> <span>System</span><span>.</span><span>Threading</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC4"></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC5"><span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC6"><span>{</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC7"><span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC8"><span>{</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC9"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC10"><span>{</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC11"><span>bool</span> <span>taken</span> <span>=</span> <span>false</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC12"><span>var</span> <span>sl</span> <span>=</span> <span>new</span> <span>SpinLock</span><span>(</span><span>false</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC13"><span>sl</span><span>.</span><span>Enter</span><span>(</span><span>ref</span> <span>taken</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC14"></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC15"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC16"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>100_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC17"><span>{</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC18"><span>taken</span> <span>=</span> <span>false</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC19"><span>sl</span><span>.</span><span>TryEnter</span><span>(</span><span>0</span><span>,</span> <span>ref</span> <span>taken</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC20"><span>}</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC21"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC22"><span>}</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC23"><span>}</span></td></tr><tr><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-L24" data-line-number="24"></td><td id="file-perfblog06062017_spinlock_tryenter_alreadyacquired-cs-LC24"><span>}</span></td></tr></tbody></table>

On .NET 4.7, I get results like:

00:00:02.3276463 00:00:02.3174042 00:00:02.3022212 00:00:02.3015542 00:00:02.2974777

whereas on .NET Core 2.0, I get results like:

00:00:00.3915327 00:00:00.3953084 00:00:00.3875121 00:00:00.3980009 00:00:00.3886977

Such an ~6x difference in throughput can make a significant impact on hot paths that exercise such locks.

That’s just one example of many. Another is around [Lazy<T>](https://docs.microsoft.com/dotnet/api/system.lazy-1), which was rewritten in PR [dotnet/coreclr #8963](https://github.com/dotnet/coreclr/pull/8963) by [manofstick](https://github.com/manofstick) to improve the efficiency of accessing an already initialized [Lazy<T>](https://docs.microsoft.com/dotnet/api/system.lazy-1) (while the performance of accessing a [Lazy<T>](https://docs.microsoft.com/dotnet/api/system.lazy-1) for the first time matters, the expectation is that it’s accessed many times after that, and thus we want to minimize the cost of those subsequent accesses). The effect is visible in a small example like the following:

<table data-hpc="" data-tab-size="4" data-paste-markdown-skip="" data-tagsearch-path="PerfBlog06062017_Lazy_Value.cs"><tbody><tr><td id="file-perfblog06062017_lazy_value-cs-L1" data-line-number="1"></td><td id="file-perfblog06062017_lazy_value-cs-LC1"><span>using</span> <span>System</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L2" data-line-number="2"></td><td id="file-perfblog06062017_lazy_value-cs-LC2"><span>using</span> <span>System</span><span>.</span><span>Diagnostics</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L3" data-line-number="3"></td><td id="file-perfblog06062017_lazy_value-cs-LC3"></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L4" data-line-number="4"></td><td id="file-perfblog06062017_lazy_value-cs-LC4"><span>class</span> <span>Test</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L5" data-line-number="5"></td><td id="file-perfblog06062017_lazy_value-cs-LC5"><span>{</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L6" data-line-number="6"></td><td id="file-perfblog06062017_lazy_value-cs-LC6"><span><span>static</span></span> <span>int</span> <span>s_result</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L7" data-line-number="7"></td><td id="file-perfblog06062017_lazy_value-cs-LC7"></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L8" data-line-number="8"></td><td id="file-perfblog06062017_lazy_value-cs-LC8"><span><span>static</span></span> <span>void</span> <span>Main</span><span>(</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L9" data-line-number="9"></td><td id="file-perfblog06062017_lazy_value-cs-LC9"><span>{</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L10" data-line-number="10"></td><td id="file-perfblog06062017_lazy_value-cs-LC10"><span>while</span> <span>(</span><span>true</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L11" data-line-number="11"></td><td id="file-perfblog06062017_lazy_value-cs-LC11"><span>{</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L12" data-line-number="12"></td><td id="file-perfblog06062017_lazy_value-cs-LC12"><span>var</span> <span>lazy</span> <span>=</span> <span>new</span> <span>Lazy</span><span>&lt;</span><span>int</span><span>&gt;</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>42</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L13" data-line-number="13"></td><td id="file-perfblog06062017_lazy_value-cs-LC13"><span>s_result</span> <span>=</span> <span>lazy</span><span>.</span><span>Value</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L14" data-line-number="14"></td><td id="file-perfblog06062017_lazy_value-cs-LC14"></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L15" data-line-number="15"></td><td id="file-perfblog06062017_lazy_value-cs-LC15"><span>var</span> <span>sw</span> <span>=</span> <span>Stopwatch</span><span>.</span><span>StartNew</span><span>(</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L16" data-line-number="16"></td><td id="file-perfblog06062017_lazy_value-cs-LC16"><span>for</span> <span>(</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>1_000_000_000</span><span>;</span> <span>i</span><span>++</span><span>)</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L17" data-line-number="17"></td><td id="file-perfblog06062017_lazy_value-cs-LC17"><span>{</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L18" data-line-number="18"></td><td id="file-perfblog06062017_lazy_value-cs-LC18"><span>s_result</span> <span>=</span> <span>lazy</span><span>.</span><span>Value</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L19" data-line-number="19"></td><td id="file-perfblog06062017_lazy_value-cs-LC19"><span>}</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L20" data-line-number="20"></td><td id="file-perfblog06062017_lazy_value-cs-LC20"><span>Console</span><span>.</span><span>WriteLine</span><span>(</span><span>sw</span><span>.</span><span>Elapsed</span><span>)</span><span>;</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L21" data-line-number="21"></td><td id="file-perfblog06062017_lazy_value-cs-LC21"><span>}</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L22" data-line-number="22"></td><td id="file-perfblog06062017_lazy_value-cs-LC22"><span>}</span></td></tr><tr><td id="file-perfblog06062017_lazy_value-cs-L23" data-line-number="23"></td><td id="file-perfblog06062017_lazy_value-cs-LC23"><span>}</span></td></tr></tbody></table>

On .NET 4.7, I get results like:

00:00:02.6769712 00:00:02.6789140 00:00:02.6535493 00:00:02.6911146 00:00:02.7253927

whereas on .NET Core 2.0, I get results like:

00:00:00.5278348 00:00:00.5594950 00:00:00.5458245 00:00:00.5381743 00:00:00.5502970

for an ~5x increase in throughput.

#### What’s Next

As I noted earlier, these are just a few of the many performance-related improvements that have gone into .NET Core. Search for “perf” or “performance” in pull requests in the [dotnet/corefx](https://github.com/dotnet/corefx) and [dotnet/coreclr](https://github.com/dotnet/coreclr) repos, and you’ll find close to a thousand merged PRs; some of them are big and impactful on their own, while others whittle away at costs across the libraries and runtime, changes that add up to applications running faster on .NET Core. Hopefully subsequent blog posts will highlight additional performance improvements, including those in the runtime, of which there have been many but which I haven’t covered here.

We’re far from done, though. Many of the performance-related changes up until this point have been mostly ad-hoc, opportunistic changes, or those driven by specific needs that resulted from profiling specific higher-level applications and scenarios. Many have also come from the community, with developers everywhere finding and fixing issues important to them. Moving forward, performance will be a bigger focus, both in terms of adding additional performance-focused APIs (you can see experimentation with such APIs in the [dotnet/corefxlab](https://github.com/dotnet/corefxlab) repo) and in terms of improving the performance of the existing libraries.

To me, though, the most exciting part is this: you can help make all of this even better. Throughout this post I highlighted some of the many great contributions from the community, and I highly encourage everyone reading this to dig in to the .NET Core codebase, find bottlenecks impacting your own apps and libraries, and submit PRs to fix them. Rather than stumbling upon a performance issue and working around it in your app, fix it for you and everyone else to consume. We are all very excited to work with you on bringing such improvements into the code base, and we hope to see all of you involved in the various .NET Core repos.

## Author

![Stephen Toub - MSFT](https://devblogs.microsoft.com/dotnet/wp-content/uploads/sites/10/2022/03/stoub_square-96x96.jpg)

Partner Software Engineer

Stephen Toub is a developer on the .NET team at Microsoft.